"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const crypto = require("crypto");
const logging_1 = require("./logging");
const os_1 = require("./os");
const please_hold_1 = require("./util/please-hold");
/**
 * Build and upload a Docker image
 *
 * Permanently identifying images is a bit of a bust. Newer Docker version use
 * a digest (sha256:xxxx) as an image identifier, which is pretty good to avoid
 * spurious rebuilds. However, this digest is calculated over a manifest that
 * includes metadata that is liable to change. For example, as soon as we
 * push the Docker image to a repository, the digest changes. This makes the
 * digest worthless to determe whether we already pushed an image, for example.
 *
 * As a workaround, we calculate our own digest over parts of the manifest that
 * are unlikely to change, and tag based on that.
 *
 * When running in CI, we pull the latest image first and use it as cache for
 * the build. Generally pulling will be faster than building, especially for
 * Dockerfiles with lots of OS/code packages installation or changes only in
 * the bottom layers. When running locally chances are that we already have
 * layers cache available.
 *
 * CI is detected by the presence of the `CI` environment variable or
 * the `--ci` command line option.
 */
async function prepareContainerAsset(asset, toolkitInfo, reuse, ci) {
    if (reuse) {
        return [
            { ParameterKey: asset.imageNameParameter, UsePreviousValue: true },
        ];
    }
    logging_1.debug(' ðŸ‘‘  Preparing Docker image asset:', asset.path);
    const buildHold = new please_hold_1.PleaseHold(` âŒ› Building Asset Docker image ${asset.id} from ${asset.path}; this may take a while.`);
    try {
        const ecr = await toolkitInfo.prepareEcrRepository(asset);
        const latest = `${ecr.repositoryUri}:latest`;
        let loggedIn = false;
        // In CI we try to pull latest first
        if (ci) {
            await dockerLogin(toolkitInfo);
            loggedIn = true;
            try {
                await os_1.shell(['docker', 'pull', latest]);
            }
            catch (e) {
                logging_1.debug('Failed to pull latest image from ECR repository');
            }
        }
        buildHold.start();
        const baseCommand = ['docker',
            'build',
            '--quiet',
            asset.path];
        const command = ci
            ? [...baseCommand, '--cache-from', latest] // This does not fail if latest is not available
            : baseCommand;
        const imageId = (await os_1.shell(command, { quiet: true })).trim();
        buildHold.stop();
        const tag = await calculateImageFingerprint(imageId);
        logging_1.debug(` âŒ›  Image has tag ${tag}, checking ECR repository`);
        const imageExists = await toolkitInfo.checkEcrImage(ecr.repositoryName, tag);
        if (imageExists) {
            logging_1.debug(' ðŸ‘‘  Image already uploaded.');
        }
        else {
            // Login and push
            logging_1.debug(` âŒ›  Image needs to be uploaded first.`);
            if (!loggedIn) { // We could be already logged in if in CI
                await dockerLogin(toolkitInfo);
                loggedIn = true;
            }
            const qualifiedImageName = `${ecr.repositoryUri}:${tag}`;
            await os_1.shell(['docker', 'tag', imageId, qualifiedImageName]);
            // There's no way to make this quiet, so we can't use a PleaseHold. Print a header message.
            logging_1.print(` âŒ› Pushing Docker image for ${asset.path}; this may take a while.`);
            await os_1.shell(['docker', 'push', qualifiedImageName]);
            logging_1.debug(` ðŸ‘‘  Docker image for ${asset.path} pushed.`);
        }
        if (!loggedIn) { // We could be already logged in if in CI or if image did not exist
            await dockerLogin(toolkitInfo);
        }
        // Always tag and push latest
        await os_1.shell(['docker', 'tag', imageId, latest]);
        await os_1.shell(['docker', 'push', latest]);
        return [
            { ParameterKey: asset.imageNameParameter, ParameterValue: `${ecr.repositoryName}:${tag}` },
        ];
    }
    catch (e) {
        if (e.code === 'ENOENT') {
            // tslint:disable-next-line:max-line-length
            throw new Error('Error building Docker image asset; you need to have Docker installed in order to be able to build image assets. Please install Docker and try again.');
        }
        throw e;
    }
    finally {
        buildHold.stop();
    }
}
exports.prepareContainerAsset = prepareContainerAsset;
/**
 * Get credentials from ECR and run docker login
 */
async function dockerLogin(toolkitInfo) {
    const credentials = await toolkitInfo.getEcrCredentials();
    await os_1.shell(['docker', 'login',
        '--username', credentials.username,
        '--password', credentials.password,
        credentials.endpoint]);
}
/**
 * Calculate image fingerprint.
 *
 * The fingerprint has a high likelihood to be the same across repositories.
 * (As opposed to Docker's built-in image digest, which changes as soon
 * as the image is uploaded since it includes the tags that an image has).
 *
 * The fingerprint will be used as a tag to identify a particular image.
 */
async function calculateImageFingerprint(imageId) {
    const manifestString = await os_1.shell(['docker', 'inspect', imageId], { quiet: true });
    const manifest = JSON.parse(manifestString)[0];
    // Id can change
    delete manifest.Id;
    // Repository-based identifiers are out
    delete manifest.RepoTags;
    delete manifest.RepoDigests;
    // Metadata that has no bearing on the image contents
    delete manifest.Created;
    // We're interested in the image itself, not any running instaces of it
    delete manifest.Container;
    delete manifest.ContainerConfig;
    // We're not interested in the Docker version used to create this image
    delete manifest.DockerVersion;
    // On some Docker versions Metadata contains a LastTagTime which updates
    // on every push, causing us to miss all cache hits.
    delete manifest.Metadata;
    // GraphDriver is about running the image, not about the image itself.
    delete manifest.GraphDriver;
    return crypto.createHash('sha256').update(JSON.stringify(manifest)).digest('hex');
}
/**
 * Example of a Docker manifest
 *
 * [
 *     {
 *         "Id": "sha256:3a90542991d03007fd1d8f3b3a6ab04ebb02386785430fe48a867768a048d828",
 *         "RepoTags": [
 *             "993655754359.dkr.ecr.us-east-1.amazonaws.com/cdk/awsecsintegimage7c15b8c6:latest"
 *         ],
 *         "RepoDigests": [
 *             "993655754359.dkr.ecr.us-east-1.amazo....5e50c0cfc3f2355191934b05df68cd3339a044959111ffec2e14765"
 *         ],
 *         "Parent": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *         "Comment": "",
 *         "Created": "2018-10-17T10:16:40.775888476Z",
 *         "Container": "20f145d2e7fbf126ca9f4422497b932bc96b5faa038dc032de1e246f64e03a66",
 *         "ContainerConfig": {
 *             "Hostname": "9b48b580a312",
 *             "Domainname": "",
 *             "User": "",
 *             "AttachStdin": false,
 *             "AttachStdout": false,
 *             "AttachStderr": false,
 *             "ExposedPorts": {
 *                 "8000/tcp": {}
 *             },
 *             "Tty": false,
 *             "OpenStdin": false,
 *             "StdinOnce": false,
 *             "Env": [
 *                 "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
 *                 "LANG=C.UTF-8",
 *                 "GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D",
 *                 "PYTHON_VERSION=3.6.6",
 *                 "PYTHON_PIP_VERSION=18.1"
 *             ],
 *             "Cmd": [
 *                 "/bin/sh",
 *                 "-c",
 *                 "#(nop) ",
 *                 "CMD [\"/bin/sh\" \"-c\" \"python3 index.py\"]"
 *             ],
 *             "ArgsEscaped": true,
 *             "Image": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *             "Volumes": null,
 *             "WorkingDir": "/code",
 *             "Entrypoint": null,
 *             "OnBuild": [],
 *             "Labels": {}
 *         },
 *         "DockerVersion": "17.03.2-ce",
 *         "Author": "",
 *         "Config": {
 *             "Hostname": "9b48b580a312",
 *             "Domainname": "",
 *             "User": "",
 *             "AttachStdin": false,
 *             "AttachStdout": false,
 *             "AttachStderr": false,
 *             "ExposedPorts": {
 *                 "8000/tcp": {}
 *             },
 *             "Tty": false,
 *             "OpenStdin": false,
 *             "StdinOnce": false,
 *             "Env": [
 *                 "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
 *                 "LANG=C.UTF-8",
 *                 "GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D",
 *                 "PYTHON_VERSION=3.6.6",
 *                 "PYTHON_PIP_VERSION=18.1"
 *             ],
 *             "Cmd": [
 *                 "/bin/sh",
 *                 "-c",
 *                 "python3 index.py"
 *             ],
 *             "ArgsEscaped": true,
 *             "Image": "sha256:465720f8f43c9c0aff5dcc731d4e368a3927cae4e885442d4ba0bf8a867b7561",
 *             "Volumes": null,
 *             "WorkingDir": "/code",
 *             "Entrypoint": null,
 *             "OnBuild": [],
 *             "Labels": {}
 *         },
 *         "Architecture": "amd64",
 *         "Os": "linux",
 *         "Size": 917730468,
 *         "VirtualSize": 917730468,
 *         "GraphDriver": {
 *             "Name": "aufs",
 *             "Data": null
 *         },
 *         "RootFS": {
 *             "Type": "layers",
 *             "Layers": [
 *                 "sha256:f715ed19c28b66943ac8bc12dbfb828e8394de2530bbaf1ecce906e748e4fdff",
 *                 "sha256:8bb25f9cdc41e7d085033af15a522973b44086d6eedd24c11cc61c9232324f77",
 *                 "sha256:08a01612ffca33483a1847c909836610610ce523fb7e1aca880140ee84df23e9",
 *                 "sha256:1191b3f5862aa9231858809b7ac8b91c0b727ce85c9b3279932f0baacc92967d",
 *                 "sha256:9978d084fd771e0b3d1acd7f3525d1b25288ababe9ad8ed259b36101e4e3addd",
 *                 "sha256:2f4f74d3821ecbdd60b5d932452ea9e30cecf902334165c4a19837f6ee636377",
 *                 "sha256:003bb6178bc3218242d73e51d5e9ab2f991dc607780194719c6bd4c8c412fe8c",
 *                 "sha256:15b32d849da2239b1af583f9381c7a75d7aceba12f5ddfffa7a059116cf05ab9",
 *                 "sha256:6e5c5f6bf043bc634378b1e4b61af09be74741f2ac80204d7a373713b1fd5a40",
 *                 "sha256:3260e00e353bfb765b25597d13868c2ef64cb3d509875abcfb58c4e9bf7f4ee2",
 *                 "sha256:f3274b75856311e92e14a1270c78737c86456d6353fe4a83bd2e81bcd2a996ea"
 *             ]
 *         }
 *     }
 * ]
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsaUNBQWtDO0FBRWxDLHVDQUF5QztBQUN6Qyw2QkFBNkI7QUFDN0Isb0RBQWdEO0FBRWhEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FxQkc7QUFDSSxLQUFLLFVBQVUscUJBQXFCLENBQUMsS0FBdUMsRUFDdkMsV0FBd0IsRUFDeEIsS0FBYyxFQUNkLEVBQVk7SUFFdEQsSUFBSSxLQUFLLEVBQUU7UUFDVCxPQUFPO1lBQ0wsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRTtTQUNuRSxDQUFDO0tBQ0g7SUFFRCxlQUFLLENBQUMsb0NBQW9DLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXhELE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVUsQ0FBQyxrQ0FBa0MsS0FBSyxDQUFDLEVBQUUsU0FBUyxLQUFLLENBQUMsSUFBSSwwQkFBMEIsQ0FBQyxDQUFDO0lBQzFILElBQUk7UUFDRixNQUFNLEdBQUcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxRCxNQUFNLE1BQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxhQUFhLFNBQVMsQ0FBQztRQUU3QyxJQUFJLFFBQVEsR0FBRyxLQUFLLENBQUM7UUFFckIsb0NBQW9DO1FBQ3BDLElBQUksRUFBRSxFQUFFO1lBQ04sTUFBTSxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDL0IsUUFBUSxHQUFHLElBQUksQ0FBQztZQUVoQixJQUFJO2dCQUNGLE1BQU0sVUFBSyxDQUFDLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQ3pDO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsZUFBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7YUFDMUQ7U0FDRjtRQUVELFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVsQixNQUFNLFdBQVcsR0FBRyxDQUFDLFFBQVE7WUFDM0IsT0FBTztZQUNQLFNBQVM7WUFDVCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDZCxNQUFNLE9BQU8sR0FBRyxFQUFFO1lBQ2hCLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxFQUFFLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQyxnREFBZ0Q7WUFDM0YsQ0FBQyxDQUFDLFdBQVcsQ0FBQztRQUNoQixNQUFNLE9BQU8sR0FBRyxDQUFDLE1BQU0sVUFBSyxDQUFDLE9BQU8sRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFL0QsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpCLE1BQU0sR0FBRyxHQUFHLE1BQU0seUJBQXlCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFckQsZUFBSyxDQUFDLHFCQUFxQixHQUFHLDJCQUEyQixDQUFDLENBQUM7UUFDM0QsTUFBTSxXQUFXLEdBQUcsTUFBTSxXQUFXLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFN0UsSUFBSSxXQUFXLEVBQUU7WUFDZixlQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztTQUN2QzthQUFNO1lBQ0wsaUJBQWlCO1lBQ2pCLGVBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO1lBRS9DLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSx5Q0FBeUM7Z0JBQ3hELE1BQU0sV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUMvQixRQUFRLEdBQUcsSUFBSSxDQUFDO2FBQ2pCO1lBRUQsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLEdBQUcsQ0FBQyxhQUFhLElBQUksR0FBRyxFQUFFLENBQUM7WUFFekQsTUFBTSxVQUFLLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFFNUQsMkZBQTJGO1lBQzNGLGVBQUssQ0FBQywrQkFBK0IsS0FBSyxDQUFDLElBQUksMEJBQTBCLENBQUMsQ0FBQztZQUMzRSxNQUFNLFVBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1lBQ3BELGVBQUssQ0FBQyx5QkFBeUIsS0FBSyxDQUFDLElBQUksVUFBVSxDQUFDLENBQUM7U0FDdEQ7UUFFRCxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsbUVBQW1FO1lBQ2xGLE1BQU0sV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ2hDO1FBRUQsNkJBQTZCO1FBQzdCLE1BQU0sVUFBSyxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNoRCxNQUFNLFVBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUV4QyxPQUFPO1lBQ0wsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxjQUFjLElBQUksR0FBRyxFQUFFLEVBQUU7U0FDM0YsQ0FBQztLQUNIO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDVixJQUFJLENBQUMsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQ3ZCLDJDQUEyQztZQUMzQyxNQUFNLElBQUksS0FBSyxDQUFDLHNKQUFzSixDQUFDLENBQUM7U0FDeks7UUFDRCxNQUFNLENBQUMsQ0FBQztLQUNUO1lBQVM7UUFDUixTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDbEI7QUFDSCxDQUFDO0FBM0ZELHNEQTJGQztBQUVEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLFdBQVcsQ0FBQyxXQUF3QjtJQUNqRCxNQUFNLFdBQVcsR0FBRyxNQUFNLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzFELE1BQU0sVUFBSyxDQUFDLENBQUMsUUFBUSxFQUFFLE9BQU87UUFDOUIsWUFBWSxFQUFFLFdBQVcsQ0FBQyxRQUFRO1FBQ2xDLFlBQVksRUFBRSxXQUFXLENBQUMsUUFBUTtRQUNsQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUN6QixDQUFDO0FBRUQ7Ozs7Ozs7O0dBUUc7QUFDSCxLQUFLLFVBQVUseUJBQXlCLENBQUMsT0FBZTtJQUN0RCxNQUFNLGNBQWMsR0FBRyxNQUFNLFVBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNwRixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRS9DLGdCQUFnQjtJQUNoQixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUM7SUFFbkIsdUNBQXVDO0lBQ3ZDLE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FBQztJQUN6QixPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7SUFFNUIscURBQXFEO0lBQ3JELE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQztJQUV4Qix1RUFBdUU7SUFDdkUsT0FBTyxRQUFRLENBQUMsU0FBUyxDQUFDO0lBQzFCLE9BQU8sUUFBUSxDQUFDLGVBQWUsQ0FBQztJQUVoQyx1RUFBdUU7SUFDdkUsT0FBTyxRQUFRLENBQUMsYUFBYSxDQUFDO0lBRTlCLHdFQUF3RTtJQUN4RSxvREFBb0Q7SUFDcEQsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDO0lBRXpCLHNFQUFzRTtJQUN0RSxPQUFPLFFBQVEsQ0FBQyxXQUFXLENBQUM7SUFFNUIsT0FBTyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3BGLENBQUM7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBK0dHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnkgfSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb24gfSBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcbmltcG9ydCB7IFRvb2xraXRJbmZvIH0gZnJvbSAnLi9hcGkvdG9vbGtpdC1pbmZvJztcbmltcG9ydCB7IGRlYnVnLCBwcmludCB9IGZyb20gJy4vbG9nZ2luZyc7XG5pbXBvcnQgeyBzaGVsbCB9IGZyb20gJy4vb3MnO1xuaW1wb3J0IHsgUGxlYXNlSG9sZCB9IGZyb20gJy4vdXRpbC9wbGVhc2UtaG9sZCc7XG5cbi8qKlxuICogQnVpbGQgYW5kIHVwbG9hZCBhIERvY2tlciBpbWFnZVxuICpcbiAqIFBlcm1hbmVudGx5IGlkZW50aWZ5aW5nIGltYWdlcyBpcyBhIGJpdCBvZiBhIGJ1c3QuIE5ld2VyIERvY2tlciB2ZXJzaW9uIHVzZVxuICogYSBkaWdlc3QgKHNoYTI1Njp4eHh4KSBhcyBhbiBpbWFnZSBpZGVudGlmaWVyLCB3aGljaCBpcyBwcmV0dHkgZ29vZCB0byBhdm9pZFxuICogc3B1cmlvdXMgcmVidWlsZHMuIEhvd2V2ZXIsIHRoaXMgZGlnZXN0IGlzIGNhbGN1bGF0ZWQgb3ZlciBhIG1hbmlmZXN0IHRoYXRcbiAqIGluY2x1ZGVzIG1ldGFkYXRhIHRoYXQgaXMgbGlhYmxlIHRvIGNoYW5nZS4gRm9yIGV4YW1wbGUsIGFzIHNvb24gYXMgd2VcbiAqIHB1c2ggdGhlIERvY2tlciBpbWFnZSB0byBhIHJlcG9zaXRvcnksIHRoZSBkaWdlc3QgY2hhbmdlcy4gVGhpcyBtYWtlcyB0aGVcbiAqIGRpZ2VzdCB3b3J0aGxlc3MgdG8gZGV0ZXJtZSB3aGV0aGVyIHdlIGFscmVhZHkgcHVzaGVkIGFuIGltYWdlLCBmb3IgZXhhbXBsZS5cbiAqXG4gKiBBcyBhIHdvcmthcm91bmQsIHdlIGNhbGN1bGF0ZSBvdXIgb3duIGRpZ2VzdCBvdmVyIHBhcnRzIG9mIHRoZSBtYW5pZmVzdCB0aGF0XG4gKiBhcmUgdW5saWtlbHkgdG8gY2hhbmdlLCBhbmQgdGFnIGJhc2VkIG9uIHRoYXQuXG4gKlxuICogV2hlbiBydW5uaW5nIGluIENJLCB3ZSBwdWxsIHRoZSBsYXRlc3QgaW1hZ2UgZmlyc3QgYW5kIHVzZSBpdCBhcyBjYWNoZSBmb3JcbiAqIHRoZSBidWlsZC4gR2VuZXJhbGx5IHB1bGxpbmcgd2lsbCBiZSBmYXN0ZXIgdGhhbiBidWlsZGluZywgZXNwZWNpYWxseSBmb3JcbiAqIERvY2tlcmZpbGVzIHdpdGggbG90cyBvZiBPUy9jb2RlIHBhY2thZ2VzIGluc3RhbGxhdGlvbiBvciBjaGFuZ2VzIG9ubHkgaW5cbiAqIHRoZSBib3R0b20gbGF5ZXJzLiBXaGVuIHJ1bm5pbmcgbG9jYWxseSBjaGFuY2VzIGFyZSB0aGF0IHdlIGFscmVhZHkgaGF2ZVxuICogbGF5ZXJzIGNhY2hlIGF2YWlsYWJsZS5cbiAqXG4gKiBDSSBpcyBkZXRlY3RlZCBieSB0aGUgcHJlc2VuY2Ugb2YgdGhlIGBDSWAgZW52aXJvbm1lbnQgdmFyaWFibGUgb3JcbiAqIHRoZSBgLS1jaWAgY29tbWFuZCBsaW5lIG9wdGlvbi5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByZXBhcmVDb250YWluZXJBc3NldChhc3NldDogQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xraXRJbmZvOiBUb29sa2l0SW5mbyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV1c2U6IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNpPzogYm9vbGVhbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcblxuICBpZiAocmV1c2UpIHtcbiAgICByZXR1cm4gW1xuICAgICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LmltYWdlTmFtZVBhcmFtZXRlciwgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgIF07XG4gIH1cblxuICBkZWJ1ZygnIPCfkZEgIFByZXBhcmluZyBEb2NrZXIgaW1hZ2UgYXNzZXQ6JywgYXNzZXQucGF0aCk7XG5cbiAgY29uc3QgYnVpbGRIb2xkID0gbmV3IFBsZWFzZUhvbGQoYCDijJsgQnVpbGRpbmcgQXNzZXQgRG9ja2VyIGltYWdlICR7YXNzZXQuaWR9IGZyb20gJHthc3NldC5wYXRofTsgdGhpcyBtYXkgdGFrZSBhIHdoaWxlLmApO1xuICB0cnkge1xuICAgIGNvbnN0IGVjciA9IGF3YWl0IHRvb2xraXRJbmZvLnByZXBhcmVFY3JSZXBvc2l0b3J5KGFzc2V0KTtcbiAgICBjb25zdCBsYXRlc3QgPSBgJHtlY3IucmVwb3NpdG9yeVVyaX06bGF0ZXN0YDtcblxuICAgIGxldCBsb2dnZWRJbiA9IGZhbHNlO1xuXG4gICAgLy8gSW4gQ0kgd2UgdHJ5IHRvIHB1bGwgbGF0ZXN0IGZpcnN0XG4gICAgaWYgKGNpKSB7XG4gICAgICBhd2FpdCBkb2NrZXJMb2dpbih0b29sa2l0SW5mbyk7XG4gICAgICBsb2dnZWRJbiA9IHRydWU7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ3B1bGwnLCBsYXRlc3RdKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZGVidWcoJ0ZhaWxlZCB0byBwdWxsIGxhdGVzdCBpbWFnZSBmcm9tIEVDUiByZXBvc2l0b3J5Jyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYnVpbGRIb2xkLnN0YXJ0KCk7XG5cbiAgICBjb25zdCBiYXNlQ29tbWFuZCA9IFsnZG9ja2VyJyxcbiAgICAgICdidWlsZCcsXG4gICAgICAnLS1xdWlldCcsXG4gICAgICBhc3NldC5wYXRoXTtcbiAgICBjb25zdCBjb21tYW5kID0gY2lcbiAgICAgID8gWy4uLmJhc2VDb21tYW5kLCAnLS1jYWNoZS1mcm9tJywgbGF0ZXN0XSAvLyBUaGlzIGRvZXMgbm90IGZhaWwgaWYgbGF0ZXN0IGlzIG5vdCBhdmFpbGFibGVcbiAgICAgIDogYmFzZUNvbW1hbmQ7XG4gICAgY29uc3QgaW1hZ2VJZCA9IChhd2FpdCBzaGVsbChjb21tYW5kLCB7IHF1aWV0OiB0cnVlIH0pKS50cmltKCk7XG5cbiAgICBidWlsZEhvbGQuc3RvcCgpO1xuXG4gICAgY29uc3QgdGFnID0gYXdhaXQgY2FsY3VsYXRlSW1hZ2VGaW5nZXJwcmludChpbWFnZUlkKTtcblxuICAgIGRlYnVnKGAg4oybICBJbWFnZSBoYXMgdGFnICR7dGFnfSwgY2hlY2tpbmcgRUNSIHJlcG9zaXRvcnlgKTtcbiAgICBjb25zdCBpbWFnZUV4aXN0cyA9IGF3YWl0IHRvb2xraXRJbmZvLmNoZWNrRWNySW1hZ2UoZWNyLnJlcG9zaXRvcnlOYW1lLCB0YWcpO1xuXG4gICAgaWYgKGltYWdlRXhpc3RzKSB7XG4gICAgICBkZWJ1ZygnIPCfkZEgIEltYWdlIGFscmVhZHkgdXBsb2FkZWQuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIExvZ2luIGFuZCBwdXNoXG4gICAgICBkZWJ1ZyhgIOKMmyAgSW1hZ2UgbmVlZHMgdG8gYmUgdXBsb2FkZWQgZmlyc3QuYCk7XG5cbiAgICAgIGlmICghbG9nZ2VkSW4pIHsgLy8gV2UgY291bGQgYmUgYWxyZWFkeSBsb2dnZWQgaW4gaWYgaW4gQ0lcbiAgICAgICAgYXdhaXQgZG9ja2VyTG9naW4odG9vbGtpdEluZm8pO1xuICAgICAgICBsb2dnZWRJbiA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHF1YWxpZmllZEltYWdlTmFtZSA9IGAke2Vjci5yZXBvc2l0b3J5VXJpfToke3RhZ31gO1xuXG4gICAgICBhd2FpdCBzaGVsbChbJ2RvY2tlcicsICd0YWcnLCBpbWFnZUlkLCBxdWFsaWZpZWRJbWFnZU5hbWVdKTtcblxuICAgICAgLy8gVGhlcmUncyBubyB3YXkgdG8gbWFrZSB0aGlzIHF1aWV0LCBzbyB3ZSBjYW4ndCB1c2UgYSBQbGVhc2VIb2xkLiBQcmludCBhIGhlYWRlciBtZXNzYWdlLlxuICAgICAgcHJpbnQoYCDijJsgUHVzaGluZyBEb2NrZXIgaW1hZ2UgZm9yICR7YXNzZXQucGF0aH07IHRoaXMgbWF5IHRha2UgYSB3aGlsZS5gKTtcbiAgICAgIGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ3B1c2gnLCBxdWFsaWZpZWRJbWFnZU5hbWVdKTtcbiAgICAgIGRlYnVnKGAg8J+RkSAgRG9ja2VyIGltYWdlIGZvciAke2Fzc2V0LnBhdGh9IHB1c2hlZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWxvZ2dlZEluKSB7IC8vIFdlIGNvdWxkIGJlIGFscmVhZHkgbG9nZ2VkIGluIGlmIGluIENJIG9yIGlmIGltYWdlIGRpZCBub3QgZXhpc3RcbiAgICAgIGF3YWl0IGRvY2tlckxvZ2luKHRvb2xraXRJbmZvKTtcbiAgICB9XG5cbiAgICAvLyBBbHdheXMgdGFnIGFuZCBwdXNoIGxhdGVzdFxuICAgIGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ3RhZycsIGltYWdlSWQsIGxhdGVzdF0pO1xuICAgIGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ3B1c2gnLCBsYXRlc3RdKTtcblxuICAgIHJldHVybiBbXG4gICAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuaW1hZ2VOYW1lUGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogYCR7ZWNyLnJlcG9zaXRvcnlOYW1lfToke3RhZ31gIH0sXG4gICAgXTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGJ1aWxkaW5nIERvY2tlciBpbWFnZSBhc3NldDsgeW91IG5lZWQgdG8gaGF2ZSBEb2NrZXIgaW5zdGFsbGVkIGluIG9yZGVyIHRvIGJlIGFibGUgdG8gYnVpbGQgaW1hZ2UgYXNzZXRzLiBQbGVhc2UgaW5zdGFsbCBEb2NrZXIgYW5kIHRyeSBhZ2Fpbi4nKTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfSBmaW5hbGx5IHtcbiAgICBidWlsZEhvbGQuc3RvcCgpO1xuICB9XG59XG5cbi8qKlxuICogR2V0IGNyZWRlbnRpYWxzIGZyb20gRUNSIGFuZCBydW4gZG9ja2VyIGxvZ2luXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRvY2tlckxvZ2luKHRvb2xraXRJbmZvOiBUb29sa2l0SW5mbykge1xuICBjb25zdCBjcmVkZW50aWFscyA9IGF3YWl0IHRvb2xraXRJbmZvLmdldEVjckNyZWRlbnRpYWxzKCk7XG4gIGF3YWl0IHNoZWxsKFsnZG9ja2VyJywgJ2xvZ2luJyxcbiAgJy0tdXNlcm5hbWUnLCBjcmVkZW50aWFscy51c2VybmFtZSxcbiAgJy0tcGFzc3dvcmQnLCBjcmVkZW50aWFscy5wYXNzd29yZCxcbiAgY3JlZGVudGlhbHMuZW5kcG9pbnRdKTtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgaW1hZ2UgZmluZ2VycHJpbnQuXG4gKlxuICogVGhlIGZpbmdlcnByaW50IGhhcyBhIGhpZ2ggbGlrZWxpaG9vZCB0byBiZSB0aGUgc2FtZSBhY3Jvc3MgcmVwb3NpdG9yaWVzLlxuICogKEFzIG9wcG9zZWQgdG8gRG9ja2VyJ3MgYnVpbHQtaW4gaW1hZ2UgZGlnZXN0LCB3aGljaCBjaGFuZ2VzIGFzIHNvb25cbiAqIGFzIHRoZSBpbWFnZSBpcyB1cGxvYWRlZCBzaW5jZSBpdCBpbmNsdWRlcyB0aGUgdGFncyB0aGF0IGFuIGltYWdlIGhhcykuXG4gKlxuICogVGhlIGZpbmdlcnByaW50IHdpbGwgYmUgdXNlZCBhcyBhIHRhZyB0byBpZGVudGlmeSBhIHBhcnRpY3VsYXIgaW1hZ2UuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGNhbGN1bGF0ZUltYWdlRmluZ2VycHJpbnQoaW1hZ2VJZDogc3RyaW5nKSB7XG4gIGNvbnN0IG1hbmlmZXN0U3RyaW5nID0gYXdhaXQgc2hlbGwoWydkb2NrZXInLCAnaW5zcGVjdCcsIGltYWdlSWRdLCB7IHF1aWV0OiB0cnVlIH0pO1xuICBjb25zdCBtYW5pZmVzdCA9IEpTT04ucGFyc2UobWFuaWZlc3RTdHJpbmcpWzBdO1xuXG4gIC8vIElkIGNhbiBjaGFuZ2VcbiAgZGVsZXRlIG1hbmlmZXN0LklkO1xuXG4gIC8vIFJlcG9zaXRvcnktYmFzZWQgaWRlbnRpZmllcnMgYXJlIG91dFxuICBkZWxldGUgbWFuaWZlc3QuUmVwb1RhZ3M7XG4gIGRlbGV0ZSBtYW5pZmVzdC5SZXBvRGlnZXN0cztcblxuICAvLyBNZXRhZGF0YSB0aGF0IGhhcyBubyBiZWFyaW5nIG9uIHRoZSBpbWFnZSBjb250ZW50c1xuICBkZWxldGUgbWFuaWZlc3QuQ3JlYXRlZDtcblxuICAvLyBXZSdyZSBpbnRlcmVzdGVkIGluIHRoZSBpbWFnZSBpdHNlbGYsIG5vdCBhbnkgcnVubmluZyBpbnN0YWNlcyBvZiBpdFxuICBkZWxldGUgbWFuaWZlc3QuQ29udGFpbmVyO1xuICBkZWxldGUgbWFuaWZlc3QuQ29udGFpbmVyQ29uZmlnO1xuXG4gIC8vIFdlJ3JlIG5vdCBpbnRlcmVzdGVkIGluIHRoZSBEb2NrZXIgdmVyc2lvbiB1c2VkIHRvIGNyZWF0ZSB0aGlzIGltYWdlXG4gIGRlbGV0ZSBtYW5pZmVzdC5Eb2NrZXJWZXJzaW9uO1xuXG4gIC8vIE9uIHNvbWUgRG9ja2VyIHZlcnNpb25zIE1ldGFkYXRhIGNvbnRhaW5zIGEgTGFzdFRhZ1RpbWUgd2hpY2ggdXBkYXRlc1xuICAvLyBvbiBldmVyeSBwdXNoLCBjYXVzaW5nIHVzIHRvIG1pc3MgYWxsIGNhY2hlIGhpdHMuXG4gIGRlbGV0ZSBtYW5pZmVzdC5NZXRhZGF0YTtcblxuICAvLyBHcmFwaERyaXZlciBpcyBhYm91dCBydW5uaW5nIHRoZSBpbWFnZSwgbm90IGFib3V0IHRoZSBpbWFnZSBpdHNlbGYuXG4gIGRlbGV0ZSBtYW5pZmVzdC5HcmFwaERyaXZlcjtcblxuICByZXR1cm4gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpLnVwZGF0ZShKU09OLnN0cmluZ2lmeShtYW5pZmVzdCkpLmRpZ2VzdCgnaGV4Jyk7XG59XG5cbi8qKlxuICogRXhhbXBsZSBvZiBhIERvY2tlciBtYW5pZmVzdFxuICpcbiAqIFtcbiAqICAgICB7XG4gKiAgICAgICAgIFwiSWRcIjogXCJzaGEyNTY6M2E5MDU0Mjk5MWQwMzAwN2ZkMWQ4ZjNiM2E2YWIwNGViYjAyMzg2Nzg1NDMwZmU0OGE4Njc3NjhhMDQ4ZDgyOFwiLFxuICogICAgICAgICBcIlJlcG9UYWdzXCI6IFtcbiAqICAgICAgICAgICAgIFwiOTkzNjU1NzU0MzU5LmRrci5lY3IudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vY2RrL2F3c2Vjc2ludGVnaW1hZ2U3YzE1YjhjNjpsYXRlc3RcIlxuICogICAgICAgICBdLFxuICogICAgICAgICBcIlJlcG9EaWdlc3RzXCI6IFtcbiAqICAgICAgICAgICAgIFwiOTkzNjU1NzU0MzU5LmRrci5lY3IudXMtZWFzdC0xLmFtYXpvLi4uLjVlNTBjMGNmYzNmMjM1NTE5MTkzNGIwNWRmNjhjZDMzMzlhMDQ0OTU5MTExZmZlYzJlMTQ3NjVcIlxuICogICAgICAgICBdLFxuICogICAgICAgICBcIlBhcmVudFwiOiBcInNoYTI1Njo0NjU3MjBmOGY0M2M5YzBhZmY1ZGNjNzMxZDRlMzY4YTM5MjdjYWU0ZTg4NTQ0MmQ0YmEwYmY4YTg2N2I3NTYxXCIsXG4gKiAgICAgICAgIFwiQ29tbWVudFwiOiBcIlwiLFxuICogICAgICAgICBcIkNyZWF0ZWRcIjogXCIyMDE4LTEwLTE3VDEwOjE2OjQwLjc3NTg4ODQ3NlpcIixcbiAqICAgICAgICAgXCJDb250YWluZXJcIjogXCIyMGYxNDVkMmU3ZmJmMTI2Y2E5ZjQ0MjI0OTdiOTMyYmM5NmI1ZmFhMDM4ZGMwMzJkZTFlMjQ2ZjY0ZTAzYTY2XCIsXG4gKiAgICAgICAgIFwiQ29udGFpbmVyQ29uZmlnXCI6IHtcbiAqICAgICAgICAgICAgIFwiSG9zdG5hbWVcIjogXCI5YjQ4YjU4MGEzMTJcIixcbiAqICAgICAgICAgICAgIFwiRG9tYWlubmFtZVwiOiBcIlwiLFxuICogICAgICAgICAgICAgXCJVc2VyXCI6IFwiXCIsXG4gKiAgICAgICAgICAgICBcIkF0dGFjaFN0ZGluXCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRvdXRcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIkF0dGFjaFN0ZGVyclwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiRXhwb3NlZFBvcnRzXCI6IHtcbiAqICAgICAgICAgICAgICAgICBcIjgwMDAvdGNwXCI6IHt9XG4gKiAgICAgICAgICAgICB9LFxuICogICAgICAgICAgICAgXCJUdHlcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIk9wZW5TdGRpblwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiU3RkaW5PbmNlXCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJFbnZcIjogW1xuICogICAgICAgICAgICAgICAgIFwiUEFUSD0vdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW46L3Vzci9sb2NhbC9iaW46L3Vzci9zYmluOi91c3IvYmluOi9zYmluOi9iaW5cIixcbiAqICAgICAgICAgICAgICAgICBcIkxBTkc9Qy5VVEYtOFwiLFxuICogICAgICAgICAgICAgICAgIFwiR1BHX0tFWT0wRDk2REY0RDQxMTBFNUM0M0ZCRkIxN0YyRDM0N0VBNkFBNjU0MjFEXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJQWVRIT05fVkVSU0lPTj0zLjYuNlwiLFxuICogICAgICAgICAgICAgICAgIFwiUFlUSE9OX1BJUF9WRVJTSU9OPTE4LjFcIlxuICogICAgICAgICAgICAgXSxcbiAqICAgICAgICAgICAgIFwiQ21kXCI6IFtcbiAqICAgICAgICAgICAgICAgICBcIi9iaW4vc2hcIixcbiAqICAgICAgICAgICAgICAgICBcIi1jXCIsXG4gKiAgICAgICAgICAgICAgICAgXCIjKG5vcCkgXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJDTUQgW1xcXCIvYmluL3NoXFxcIiBcXFwiLWNcXFwiIFxcXCJweXRob24zIGluZGV4LnB5XFxcIl1cIlxuICogICAgICAgICAgICAgXSxcbiAqICAgICAgICAgICAgIFwiQXJnc0VzY2FwZWRcIjogdHJ1ZSxcbiAqICAgICAgICAgICAgIFwiSW1hZ2VcIjogXCJzaGEyNTY6NDY1NzIwZjhmNDNjOWMwYWZmNWRjYzczMWQ0ZTM2OGEzOTI3Y2FlNGU4ODU0NDJkNGJhMGJmOGE4NjdiNzU2MVwiLFxuICogICAgICAgICAgICAgXCJWb2x1bWVzXCI6IG51bGwsXG4gKiAgICAgICAgICAgICBcIldvcmtpbmdEaXJcIjogXCIvY29kZVwiLFxuICogICAgICAgICAgICAgXCJFbnRyeXBvaW50XCI6IG51bGwsXG4gKiAgICAgICAgICAgICBcIk9uQnVpbGRcIjogW10sXG4gKiAgICAgICAgICAgICBcIkxhYmVsc1wiOiB7fVxuICogICAgICAgICB9LFxuICogICAgICAgICBcIkRvY2tlclZlcnNpb25cIjogXCIxNy4wMy4yLWNlXCIsXG4gKiAgICAgICAgIFwiQXV0aG9yXCI6IFwiXCIsXG4gKiAgICAgICAgIFwiQ29uZmlnXCI6IHtcbiAqICAgICAgICAgICAgIFwiSG9zdG5hbWVcIjogXCI5YjQ4YjU4MGEzMTJcIixcbiAqICAgICAgICAgICAgIFwiRG9tYWlubmFtZVwiOiBcIlwiLFxuICogICAgICAgICAgICAgXCJVc2VyXCI6IFwiXCIsXG4gKiAgICAgICAgICAgICBcIkF0dGFjaFN0ZGluXCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJBdHRhY2hTdGRvdXRcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIkF0dGFjaFN0ZGVyclwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiRXhwb3NlZFBvcnRzXCI6IHtcbiAqICAgICAgICAgICAgICAgICBcIjgwMDAvdGNwXCI6IHt9XG4gKiAgICAgICAgICAgICB9LFxuICogICAgICAgICAgICAgXCJUdHlcIjogZmFsc2UsXG4gKiAgICAgICAgICAgICBcIk9wZW5TdGRpblwiOiBmYWxzZSxcbiAqICAgICAgICAgICAgIFwiU3RkaW5PbmNlXCI6IGZhbHNlLFxuICogICAgICAgICAgICAgXCJFbnZcIjogW1xuICogICAgICAgICAgICAgICAgIFwiUEFUSD0vdXNyL2xvY2FsL2JpbjovdXNyL2xvY2FsL3NiaW46L3Vzci9sb2NhbC9iaW46L3Vzci9zYmluOi91c3IvYmluOi9zYmluOi9iaW5cIixcbiAqICAgICAgICAgICAgICAgICBcIkxBTkc9Qy5VVEYtOFwiLFxuICogICAgICAgICAgICAgICAgIFwiR1BHX0tFWT0wRDk2REY0RDQxMTBFNUM0M0ZCRkIxN0YyRDM0N0VBNkFBNjU0MjFEXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJQWVRIT05fVkVSU0lPTj0zLjYuNlwiLFxuICogICAgICAgICAgICAgICAgIFwiUFlUSE9OX1BJUF9WRVJTSU9OPTE4LjFcIlxuICogICAgICAgICAgICAgXSxcbiAqICAgICAgICAgICAgIFwiQ21kXCI6IFtcbiAqICAgICAgICAgICAgICAgICBcIi9iaW4vc2hcIixcbiAqICAgICAgICAgICAgICAgICBcIi1jXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJweXRob24zIGluZGV4LnB5XCJcbiAqICAgICAgICAgICAgIF0sXG4gKiAgICAgICAgICAgICBcIkFyZ3NFc2NhcGVkXCI6IHRydWUsXG4gKiAgICAgICAgICAgICBcIkltYWdlXCI6IFwic2hhMjU2OjQ2NTcyMGY4ZjQzYzljMGFmZjVkY2M3MzFkNGUzNjhhMzkyN2NhZTRlODg1NDQyZDRiYTBiZjhhODY3Yjc1NjFcIixcbiAqICAgICAgICAgICAgIFwiVm9sdW1lc1wiOiBudWxsLFxuICogICAgICAgICAgICAgXCJXb3JraW5nRGlyXCI6IFwiL2NvZGVcIixcbiAqICAgICAgICAgICAgIFwiRW50cnlwb2ludFwiOiBudWxsLFxuICogICAgICAgICAgICAgXCJPbkJ1aWxkXCI6IFtdLFxuICogICAgICAgICAgICAgXCJMYWJlbHNcIjoge31cbiAqICAgICAgICAgfSxcbiAqICAgICAgICAgXCJBcmNoaXRlY3R1cmVcIjogXCJhbWQ2NFwiLFxuICogICAgICAgICBcIk9zXCI6IFwibGludXhcIixcbiAqICAgICAgICAgXCJTaXplXCI6IDkxNzczMDQ2OCxcbiAqICAgICAgICAgXCJWaXJ0dWFsU2l6ZVwiOiA5MTc3MzA0NjgsXG4gKiAgICAgICAgIFwiR3JhcGhEcml2ZXJcIjoge1xuICogICAgICAgICAgICAgXCJOYW1lXCI6IFwiYXVmc1wiLFxuICogICAgICAgICAgICAgXCJEYXRhXCI6IG51bGxcbiAqICAgICAgICAgfSxcbiAqICAgICAgICAgXCJSb290RlNcIjoge1xuICogICAgICAgICAgICAgXCJUeXBlXCI6IFwibGF5ZXJzXCIsXG4gKiAgICAgICAgICAgICBcIkxheWVyc1wiOiBbXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6ZjcxNWVkMTljMjhiNjY5NDNhYzhiYzEyZGJmYjgyOGU4Mzk0ZGUyNTMwYmJhZjFlY2NlOTA2ZTc0OGU0ZmRmZlwiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OjhiYjI1ZjljZGM0MWU3ZDA4NTAzM2FmMTVhNTIyOTczYjQ0MDg2ZDZlZWRkMjRjMTFjYzYxYzkyMzIzMjRmNzdcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1NjowOGEwMTYxMmZmY2EzMzQ4M2ExODQ3YzkwOTgzNjYxMDYxMGNlNTIzZmI3ZTFhY2E4ODAxNDBlZTg0ZGYyM2U5XCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6MTE5MWIzZjU4NjJhYTkyMzE4NTg4MDliN2FjOGI5MWMwYjcyN2NlODVjOWIzMjc5OTMyZjBiYWFjYzkyOTY3ZFwiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2Ojk5NzhkMDg0ZmQ3NzFlMGIzZDFhY2Q3ZjM1MjVkMWIyNTI4OGFiYWJlOWFkOGVkMjU5YjM2MTAxZTRlM2FkZGRcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1NjoyZjRmNzRkMzgyMWVjYmRkNjBiNWQ5MzI0NTJlYTllMzBjZWNmOTAyMzM0MTY1YzRhMTk4MzdmNmVlNjM2Mzc3XCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6MDAzYmI2MTc4YmMzMjE4MjQyZDczZTUxZDVlOWFiMmY5OTFkYzYwNzc4MDE5NDcxOWM2YmQ0YzhjNDEyZmU4Y1wiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OjE1YjMyZDg0OWRhMjIzOWIxYWY1ODNmOTM4MWM3YTc1ZDdhY2ViYTEyZjVkZGZmZmE3YTA1OTExNmNmMDVhYjlcIixcbiAqICAgICAgICAgICAgICAgICBcInNoYTI1Njo2ZTVjNWY2YmYwNDNiYzYzNDM3OGIxZTRiNjFhZjA5YmU3NDc0MWYyYWM4MDIwNGQ3YTM3MzcxM2IxZmQ1YTQwXCIsXG4gKiAgICAgICAgICAgICAgICAgXCJzaGEyNTY6MzI2MGUwMGUzNTNiZmI3NjViMjU1OTdkMTM4NjhjMmVmNjRjYjNkNTA5ODc1YWJjZmI1OGM0ZTliZjdmNGVlMlwiLFxuICogICAgICAgICAgICAgICAgIFwic2hhMjU2OmYzMjc0Yjc1ODU2MzExZTkyZTE0YTEyNzBjNzg3MzdjODY0NTZkNjM1M2ZlNGE4M2JkMmU4MWJjZDJhOTk2ZWFcIlxuICogICAgICAgICAgICAgXVxuICogICAgICAgICB9XG4gKiAgICAgfVxuICogXVxuICovXG4iXX0=