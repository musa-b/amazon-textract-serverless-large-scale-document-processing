"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable-next-line:max-line-length
const cx_api_1 = require("@aws-cdk/cx-api");
const colors = require("colors");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const archive_1 = require("./archive");
const docker_1 = require("./docker");
const logging_1 = require("./logging");
// tslint:disable-next-line:max-line-length
async function prepareAssets(stack, toolkitInfo, ci, reuse) {
    reuse = reuse || [];
    const assets = findAssets(stack.metadata);
    if (assets.length === 0) {
        return [];
    }
    if (!toolkitInfo) {
        // tslint:disable-next-line:max-line-length
        throw new Error(`This stack uses assets, so the toolkit stack must be deployed to the environment (Run "${colors.blue("cdk bootstrap " + stack.environment.name)}")`);
    }
    let params = new Array();
    for (const asset of assets) {
        // FIXME: Should have excluded by construct path here instead of by unique ID, preferably using
        // minimatch so we can support globs. Maybe take up during artifact refactoring.
        const reuseAsset = reuse.indexOf(asset.id) > -1;
        if (reuseAsset) {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)} (reusing)`);
        }
        else {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)}`);
        }
        params = params.concat(await prepareAsset(asset, toolkitInfo, reuseAsset, ci));
    }
    return params;
}
exports.prepareAssets = prepareAssets;
// tslint:disable-next-line:max-line-length
async function prepareAsset(asset, toolkitInfo, reuse, ci) {
    switch (asset.packaging) {
        case 'zip':
            return await prepareZipAsset(asset, toolkitInfo, reuse);
        case 'file':
            return await prepareFileAsset(asset, toolkitInfo, reuse);
        case 'container-image':
            return await docker_1.prepareContainerAsset(asset, toolkitInfo, reuse, ci);
        default:
            // tslint:disable-next-line:max-line-length
            throw new Error(`Unsupported packaging type: ${asset.packaging}. You might need to upgrade your aws-cdk toolkit to support this asset type.`);
    }
}
async function prepareZipAsset(asset, toolkitInfo, reuse) {
    if (reuse) {
        return await prepareFileAsset(asset, toolkitInfo, reuse);
    }
    logging_1.debug('Preparing zip asset from directory:', asset.path);
    const staging = await fs.mkdtemp(path.join(os.tmpdir(), 'cdk-assets'));
    try {
        const archiveFile = path.join(staging, 'archive.zip');
        await archive_1.zipDirectory(asset.path, archiveFile);
        logging_1.debug('zip archive:', archiveFile);
        return await prepareFileAsset(asset, toolkitInfo, reuse, archiveFile, 'application/zip');
    }
    finally {
        await fs.remove(staging);
    }
}
/**
 * @param asset The asset descriptor
 * @param toolkitInfo The toolkit stack
 * @param filePath Alternative file path to use (instead of asset.path)
 * @param contentType Content-type to use when uploading to S3 (none will be specified by default)
 */
async function prepareFileAsset(asset, toolkitInfo, reuse, filePath, contentType) {
    if (reuse) {
        return [
            { ParameterKey: asset.s3BucketParameter, UsePreviousValue: true },
            { ParameterKey: asset.s3KeyParameter, UsePreviousValue: true },
        ];
    }
    filePath = filePath || asset.path;
    logging_1.debug('Preparing file asset:', filePath);
    const data = await fs.readFile(filePath);
    const s3KeyPrefix = `assets/${asset.id}/`;
    const { filename, key, changed } = await toolkitInfo.uploadIfChanged(data, {
        s3KeyPrefix,
        s3KeySuffix: path.extname(filePath),
        contentType
    });
    const relativePath = path.relative(process.cwd(), asset.path);
    const s3url = `s3://${toolkitInfo.bucketName}/${key}`;
    logging_1.debug(`S3 url for ${relativePath}: ${s3url}`);
    if (changed) {
        logging_1.success(`Updated: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    else {
        logging_1.debug(`Up-to-date: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    return [
        { ParameterKey: asset.s3BucketParameter, ParameterValue: toolkitInfo.bucketName },
        { ParameterKey: asset.s3KeyParameter, ParameterValue: `${s3KeyPrefix}${cx_api_1.ASSET_PREFIX_SEPARATOR}${filename}` },
    ];
}
function findAssets(metadata) {
    const assets = new Array();
    for (const k of Object.keys(metadata)) {
        for (const entry of metadata[k]) {
            if (entry.type === cx_api_1.ASSET_METADATA) {
                assets.push(entry.data);
            }
        }
    }
    return assets;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTJDO0FBQzNDLDRDQUFzSjtBQUV0SixpQ0FBa0M7QUFDbEMsK0JBQWdDO0FBQ2hDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFFOUIsdUNBQXlDO0FBQ3pDLHFDQUFpRDtBQUNqRCx1Q0FBMkM7QUFFM0MsMkNBQTJDO0FBQ3BDLEtBQUssVUFBVSxhQUFhLENBQUMsS0FBdUIsRUFBRSxXQUF5QixFQUFFLEVBQVksRUFBRSxLQUFnQjtJQUNwSCxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNwQixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRTFDLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDdkIsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDaEIsMkNBQTJDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMEZBQTBGLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLFdBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDeEs7SUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBNEIsQ0FBQztJQUNuRCxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRTtRQUMxQiwrRkFBK0Y7UUFDL0YsZ0ZBQWdGO1FBQ2hGLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWhELElBQUksVUFBVSxFQUFFO1lBQ2QsZUFBSyxDQUFDLG1CQUFtQixLQUFLLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQzFF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LEVBQUU7UUFDckMsS0FBSyxNQUFNLEtBQUssSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDL0IsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLHVCQUFjLEVBQUU7Z0JBQ2pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3pCO1NBQ0Y7S0FDRjtJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG5pbXBvcnQgeyBBU1NFVF9NRVRBREFUQSwgQVNTRVRfUFJFRklYX1NFUEFSQVRPUiwgQXNzZXRNZXRhZGF0YUVudHJ5LCBGaWxlQXNzZXRNZXRhZGF0YUVudHJ5LCBTdGFja01ldGFkYXRhLCBTeW50aGVzaXplZFN0YWNrIH0gZnJvbSAnQGF3cy1jZGsvY3gtYXBpJztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uIH0gZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgY29sb3JzID0gcmVxdWlyZSgnY29sb3JzJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgVG9vbGtpdEluZm8gfSBmcm9tICcuL2FwaS90b29sa2l0LWluZm8nO1xuaW1wb3J0IHsgemlwRGlyZWN0b3J5IH0gZnJvbSAnLi9hcmNoaXZlJztcbmltcG9ydCB7IHByZXBhcmVDb250YWluZXJBc3NldCB9IGZyb20gJy4vZG9ja2VyJztcbmltcG9ydCB7IGRlYnVnLCBzdWNjZXNzIH0gZnJvbSAnLi9sb2dnaW5nJztcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByZXBhcmVBc3NldHMoc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssIHRvb2xraXRJbmZvPzogVG9vbGtpdEluZm8sIGNpPzogYm9vbGVhbiwgcmV1c2U/OiBzdHJpbmdbXSk6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcbiAgcmV1c2UgPSByZXVzZSB8fCBbXTtcbiAgY29uc3QgYXNzZXRzID0gZmluZEFzc2V0cyhzdGFjay5tZXRhZGF0YSk7XG5cbiAgaWYgKGFzc2V0cy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoIXRvb2xraXRJbmZvKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgIHRocm93IG5ldyBFcnJvcihgVGhpcyBzdGFjayB1c2VzIGFzc2V0cywgc28gdGhlIHRvb2xraXQgc3RhY2sgbXVzdCBiZSBkZXBsb3llZCB0byB0aGUgZW52aXJvbm1lbnQgKFJ1biBcIiR7Y29sb3JzLmJsdWUoXCJjZGsgYm9vdHN0cmFwIFwiICsgc3RhY2suZW52aXJvbm1lbnQhLm5hbWUpfVwiKWApO1xuICB9XG5cbiAgbGV0IHBhcmFtcyA9IG5ldyBBcnJheTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXI+KCk7XG4gIGZvciAoY29uc3QgYXNzZXQgb2YgYXNzZXRzKSB7XG4gICAgLy8gRklYTUU6IFNob3VsZCBoYXZlIGV4Y2x1ZGVkIGJ5IGNvbnN0cnVjdCBwYXRoIGhlcmUgaW5zdGVhZCBvZiBieSB1bmlxdWUgSUQsIHByZWZlcmFibHkgdXNpbmdcbiAgICAvLyBtaW5pbWF0Y2ggc28gd2UgY2FuIHN1cHBvcnQgZ2xvYnMuIE1heWJlIHRha2UgdXAgZHVyaW5nIGFydGlmYWN0IHJlZmFjdG9yaW5nLlxuICAgIGNvbnN0IHJldXNlQXNzZXQgPSByZXVzZS5pbmRleE9mKGFzc2V0LmlkKSA+IC0xO1xuXG4gICAgaWYgKHJldXNlQXNzZXQpIHtcbiAgICAgIGRlYnVnKGBQcmVwYXJpbmcgYXNzZXQgJHthc3NldC5pZH06ICR7SlNPTi5zdHJpbmdpZnkoYXNzZXQpfSAocmV1c2luZylgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVidWcoYFByZXBhcmluZyBhc3NldCAke2Fzc2V0LmlkfTogJHtKU09OLnN0cmluZ2lmeShhc3NldCl9YCk7XG4gICAgfVxuXG4gICAgcGFyYW1zID0gcGFyYW1zLmNvbmNhdChhd2FpdCBwcmVwYXJlQXNzZXQoYXNzZXQsIHRvb2xraXRJbmZvLCByZXVzZUFzc2V0LCBjaSkpO1xuICB9XG5cbiAgcmV0dXJuIHBhcmFtcztcbn1cblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUFzc2V0KGFzc2V0OiBBc3NldE1ldGFkYXRhRW50cnksIHRvb2xraXRJbmZvOiBUb29sa2l0SW5mbywgcmV1c2U6IGJvb2xlYW4sIGNpPzogYm9vbGVhbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcbiAgc3dpdGNoIChhc3NldC5wYWNrYWdpbmcpIHtcbiAgICBjYXNlICd6aXAnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVaaXBBc3NldChhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlKTtcbiAgICBjYXNlICdmaWxlJzpcbiAgICAgIHJldHVybiBhd2FpdCBwcmVwYXJlRmlsZUFzc2V0KGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UpO1xuICAgIGNhc2UgJ2NvbnRhaW5lci1pbWFnZSc6XG4gICAgICByZXR1cm4gYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UsIGNpKTtcbiAgICBkZWZhdWx0OlxuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBwYWNrYWdpbmcgdHlwZTogJHsoYXNzZXQgYXMgYW55KS5wYWNrYWdpbmd9LiBZb3UgbWlnaHQgbmVlZCB0byB1cGdyYWRlIHlvdXIgYXdzLWNkayB0b29sa2l0IHRvIHN1cHBvcnQgdGhpcyBhc3NldCB0eXBlLmApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByZXBhcmVaaXBBc3NldChhc3NldDogRmlsZUFzc2V0TWV0YWRhdGFFbnRyeSwgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvLCByZXVzZTogYm9vbGVhbik6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcbiAgaWYgKHJldXNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZXQsIHRvb2xraXRJbmZvLCByZXVzZSk7XG4gIH1cblxuICBkZWJ1ZygnUHJlcGFyaW5nIHppcCBhc3NldCBmcm9tIGRpcmVjdG9yeTonLCBhc3NldC5wYXRoKTtcbiAgY29uc3Qgc3RhZ2luZyA9IGF3YWl0IGZzLm1rZHRlbXAocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnY2RrLWFzc2V0cycpKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcmNoaXZlRmlsZSA9IHBhdGguam9pbihzdGFnaW5nLCAnYXJjaGl2ZS56aXAnKTtcbiAgICBhd2FpdCB6aXBEaXJlY3RvcnkoYXNzZXQucGF0aCwgYXJjaGl2ZUZpbGUpO1xuICAgIGRlYnVnKCd6aXAgYXJjaGl2ZTonLCBhcmNoaXZlRmlsZSk7XG4gICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZXQsIHRvb2xraXRJbmZvLCByZXVzZSwgYXJjaGl2ZUZpbGUsICdhcHBsaWNhdGlvbi96aXAnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yZW1vdmUoc3RhZ2luZyk7XG4gIH1cbn1cblxuLyoqXG4gKiBAcGFyYW0gYXNzZXQgVGhlIGFzc2V0IGRlc2NyaXB0b3JcbiAqIEBwYXJhbSB0b29sa2l0SW5mbyBUaGUgdG9vbGtpdCBzdGFja1xuICogQHBhcmFtIGZpbGVQYXRoIEFsdGVybmF0aXZlIGZpbGUgcGF0aCB0byB1c2UgKGluc3RlYWQgb2YgYXNzZXQucGF0aClcbiAqIEBwYXJhbSBjb250ZW50VHlwZSBDb250ZW50LXR5cGUgdG8gdXNlIHdoZW4gdXBsb2FkaW5nIHRvIFMzIChub25lIHdpbGwgYmUgc3BlY2lmaWVkIGJ5IGRlZmF1bHQpXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHByZXBhcmVGaWxlQXNzZXQoXG4gICAgYXNzZXQ6IEZpbGVBc3NldE1ldGFkYXRhRW50cnksXG4gICAgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvLFxuICAgIHJldXNlOiBib29sZWFuLFxuICAgIGZpbGVQYXRoPzogc3RyaW5nLFxuICAgIGNvbnRlbnRUeXBlPzogc3RyaW5nKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuXG4gIGlmIChyZXVzZSkge1xuICAgIHJldHVybiBbXG4gICAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNCdWNrZXRQYXJhbWV0ZXIsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5zM0tleVBhcmFtZXRlciwgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgIF07XG4gIH1cblxuICBmaWxlUGF0aCA9IGZpbGVQYXRoIHx8IGFzc2V0LnBhdGg7XG4gIGRlYnVnKCdQcmVwYXJpbmcgZmlsZSBhc3NldDonLCBmaWxlUGF0aCk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcblxuICBjb25zdCBzM0tleVByZWZpeCA9IGBhc3NldHMvJHthc3NldC5pZH0vYDtcblxuICBjb25zdCB7IGZpbGVuYW1lLCBrZXksIGNoYW5nZWQgfSA9IGF3YWl0IHRvb2xraXRJbmZvLnVwbG9hZElmQ2hhbmdlZChkYXRhLCB7XG4gICAgczNLZXlQcmVmaXgsXG4gICAgczNLZXlTdWZmaXg6IHBhdGguZXh0bmFtZShmaWxlUGF0aCksXG4gICAgY29udGVudFR5cGVcbiAgfSk7XG5cbiAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBhc3NldC5wYXRoKTtcblxuICBjb25zdCBzM3VybCA9IGBzMzovLyR7dG9vbGtpdEluZm8uYnVja2V0TmFtZX0vJHtrZXl9YDtcbiAgZGVidWcoYFMzIHVybCBmb3IgJHtyZWxhdGl2ZVBhdGh9OiAke3MzdXJsfWApO1xuICBpZiAoY2hhbmdlZCkge1xuICAgIHN1Y2Nlc3MoYFVwZGF0ZWQ6ICR7Y29sb3JzLmJvbGQocmVsYXRpdmVQYXRoKX0gKCR7YXNzZXQucGFja2FnaW5nfSlgKTtcbiAgfSBlbHNlIHtcbiAgICBkZWJ1ZyhgVXAtdG8tZGF0ZTogJHtjb2xvcnMuYm9sZChyZWxhdGl2ZVBhdGgpfSAoJHthc3NldC5wYWNrYWdpbmd9KWApO1xuICB9XG5cbiAgcmV0dXJuIFtcbiAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNCdWNrZXRQYXJhbWV0ZXIsIFBhcmFtZXRlclZhbHVlOiB0b29sa2l0SW5mby5idWNrZXROYW1lIH0sXG4gICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LnMzS2V5UGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogYCR7czNLZXlQcmVmaXh9JHtBU1NFVF9QUkVGSVhfU0VQQVJBVE9SfSR7ZmlsZW5hbWV9YCB9LFxuICBdO1xufVxuXG5mdW5jdGlvbiBmaW5kQXNzZXRzKG1ldGFkYXRhOiBTdGFja01ldGFkYXRhKTogQXNzZXRNZXRhZGF0YUVudHJ5W10ge1xuICBjb25zdCBhc3NldHMgPSBuZXcgQXJyYXk8QXNzZXRNZXRhZGF0YUVudHJ5PigpO1xuXG4gIGZvciAoY29uc3QgayBvZiBPYmplY3Qua2V5cyhtZXRhZGF0YSkpIHtcbiAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIG1ldGFkYXRhW2tdKSB7XG4gICAgICBpZiAoZW50cnkudHlwZSA9PT0gQVNTRVRfTUVUQURBVEEpIHtcbiAgICAgICAgYXNzZXRzLnB1c2goZW50cnkuZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGFzc2V0cztcbn1cbiJdfQ==