"use strict";
const cxapi = require("@aws-cdk/cx-api");
const lib_1 = require("../../lib");
const stacks_1 = require("../../lib/api/cxapp/stacks");
const renames_1 = require("../../lib/renames");
const settings_1 = require("../../lib/settings");
const FIXED_RESULT = {
    version: '1',
    stacks: [
        {
            name: 'withouterrors',
            template: { resource: 'noerrorresource' },
            environment: { name: 'dev', account: '12345', region: 'here' },
            metadata: {},
        },
        {
            name: 'witherrors',
            template: { resource: 'errorresource' },
            environment: { name: 'dev', account: '12345', region: 'here' },
            metadata: {
                '/resource': [
                    {
                        type: cxapi.ERROR_METADATA_KEY,
                        data: 'this is an error',
                        trace: []
                    }
                ]
            }
        }
    ]
};
function appStacksWith(stacks) {
    const response = {
        version: '1',
        stacks,
    };
    return new stacks_1.AppStacks({
        configuration: new settings_1.Configuration(),
        aws: new lib_1.SDK(),
        synthesizer: async () => response,
    });
}
module.exports = {
    async 'do not throw when selecting stack without errors'(test) {
        // GIVEN
        const stacks = new stacks_1.AppStacks({
            configuration: new settings_1.Configuration(),
            aws: new lib_1.SDK(),
            synthesizer: async () => FIXED_RESULT,
        });
        // WHEN
        const selected = await stacks.selectStacks(['withouterrors'], stacks_1.ExtendedStackSelection.None);
        // THEN
        test.equal(selected[0].template.resource, 'noerrorresource');
        test.done();
    },
    async 'do throw when selecting stack with errors'(test) {
        // GIVEN
        const stacks = new stacks_1.AppStacks({
            configuration: new settings_1.Configuration(),
            aws: new lib_1.SDK(),
            synthesizer: async () => FIXED_RESULT,
        });
        // WHEN
        try {
            await stacks.selectStacks(['witherrors'], stacks_1.ExtendedStackSelection.None);
            test.ok(false, 'Did not get exception');
        }
        catch (e) {
            test.ok(/Found errors/.test(e.toString()), 'Wrong error');
        }
        test.done();
    },
    async 'renames get applied when stacks are selected'(test) {
        // GIVEN
        const stacks = new stacks_1.AppStacks({
            configuration: new settings_1.Configuration(),
            aws: new lib_1.SDK(),
            synthesizer: async () => FIXED_RESULT,
            renames: new renames_1.Renames({ withouterrors: 'withoutbananas' }),
        });
        // WHEN
        const synthed = await stacks.selectStacks(['withouterrors'], stacks_1.ExtendedStackSelection.None);
        // THEN
        test.equal(synthed[0].name, 'withoutbananas');
        test.equal(synthed[0].originalName, 'withouterrors');
        test.done();
    },
    async 'does not return non-autoDeployed Stacks when called without any selectors'(test) {
        // GIVEN
        const stacks = appStacksWith([
            {
                name: 'NotAutoDeployedStack',
                template: { resource: 'Resource' },
                environment: { name: 'dev', account: '12345', region: 'here' },
                metadata: {},
                autoDeploy: false,
            },
        ]);
        // WHEN
        const synthed = await stacks.selectStacks([], stacks_1.ExtendedStackSelection.None);
        // THEN
        test.equal(synthed.length, 0);
        test.done();
    },
    async 'does return non-autoDeployed Stacks when called with selectors matching it'(test) {
        // GIVEN
        const stacks = appStacksWith([
            {
                name: 'NotAutoDeployedStack',
                template: { resource: 'Resource' },
                environment: { name: 'dev', account: '12345', region: 'here' },
                metadata: {},
                autoDeploy: false,
            },
        ]);
        // WHEN
        const synthed = await stacks.selectStacks(['NotAutoDeployedStack'], stacks_1.ExtendedStackSelection.None);
        // THEN
        test.equal(synthed.length, 1);
        test.done();
    },
    async "does return an non-autoDeployed Stack when it's a dependency of a selected Stack"(test) {
        // GIVEN
        const stacks = appStacksWith([
            {
                name: 'NotAutoDeployedStack',
                template: { resource: 'Resource' },
                environment: { name: 'dev', account: '12345', region: 'here' },
                metadata: {},
                autoDeploy: false,
            },
            {
                name: 'AutoDeployedStack',
                template: { resource: 'Resource' },
                environment: { name: 'dev', account: '12345', region: 'here' },
                metadata: {},
                dependsOn: ['NotAutoDeployedStack'],
            },
        ]);
        // WHEN
        const synthed = await stacks.selectStacks(['AutoDeployedStack'], stacks_1.ExtendedStackSelection.Upstream);
        // THEN
        test.equal(synthed.length, 2);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5zdGFja3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LnN0YWNrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEseUNBQTBDO0FBRTFDLG1DQUFnQztBQUNoQyx1REFBK0U7QUFDL0UsK0NBQTRDO0FBQzVDLGlEQUFtRDtBQUVuRCxNQUFNLFlBQVksR0FBNkI7SUFDN0MsT0FBTyxFQUFFLEdBQUc7SUFDWixNQUFNLEVBQUU7UUFDTjtZQUNFLElBQUksRUFBRSxlQUFlO1lBQ3JCLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRTtZQUN6QyxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRTtZQUM5RCxRQUFRLEVBQUUsRUFBRTtTQUNiO1FBQ0Q7WUFDRSxJQUFJLEVBQUUsWUFBWTtZQUNsQixRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFO1lBQ3ZDLFdBQVcsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFO1lBQzlELFFBQVEsRUFBRTtnQkFDUixXQUFXLEVBQUU7b0JBQ1g7d0JBQ0UsSUFBSSxFQUFFLEtBQUssQ0FBQyxrQkFBa0I7d0JBQzlCLElBQUksRUFBRSxrQkFBa0I7d0JBQ3hCLEtBQUssRUFBRSxFQUFFO3FCQUNWO2lCQUNGO2FBQ0Y7U0FDRjtLQUNGO0NBQ0YsQ0FBQztBQWlJRixTQUFTLGFBQWEsQ0FBQyxNQUFnQztJQUNyRCxNQUFNLFFBQVEsR0FBNkI7UUFDekMsT0FBTyxFQUFFLEdBQUc7UUFDWixNQUFNO0tBQ1AsQ0FBQztJQUNGLE9BQU8sSUFBSSxrQkFBUyxDQUFDO1FBQ25CLGFBQWEsRUFBRSxJQUFJLHdCQUFhLEVBQUU7UUFDbEMsR0FBRyxFQUFFLElBQUksU0FBRyxFQUFFO1FBQ2QsV0FBVyxFQUFFLEtB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QUUsUUFBUSxFQUFFLFVBQVUsRUFBRTtnQkFDbEMsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7Z0JBQzlELFFBQVEsRUFBRSxFQUFFO2dCQUNaLFVBQVUsRUFBRSxLQUFLO2FBQ2xCO1lBQ0Q7Z0JBQ0UsSUFBSSxFQUFFLG1CQUFtQjtnQkFDekIsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRTtnQkFDbEMsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7Z0JBQzlELFFBQVEsRUFBRSxFQUFFO2dCQUNaLFNBQVMsRUFBRSxDQUFDLHNCQUFzQixDQUFDO2FBQ3BDO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLE1BQU0sT0FBTyxHQUFHLE1BQU0sTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsK0JBQXNCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFbEcsT0FBTztRQUNQLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjeGFwaSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2N4LWFwaScpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCB7IFNESyB9IGZyb20gJy4uLy4uL2xpYic7XG5pbXBvcnQgeyBBcHBTdGFja3MsIEV4dGVuZGVkU3RhY2tTZWxlY3Rpb24gfSBmcm9tICcuLi8uLi9saWIvYXBpL2N4YXBwL3N0YWNrcyc7XG5pbXBvcnQgeyBSZW5hbWVzIH0gZnJvbSAnLi4vLi4vbGliL3JlbmFtZXMnO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uLy4uL2xpYi9zZXR0aW5ncyc7XG5cbmNvbnN0IEZJWEVEX1JFU1VMVDogY3hhcGkuU3ludGhlc2l6ZVJlc3BvbnNlID0ge1xuICB2ZXJzaW9uOiAnMScsXG4gIHN0YWNrczogW1xuICAgIHtcbiAgICAgIG5hbWU6ICd3aXRob3V0ZXJyb3JzJyxcbiAgICAgIHRlbXBsYXRlOiB7IHJlc291cmNlOiAnbm9lcnJvcnJlc291cmNlJyB9LFxuICAgICAgZW52aXJvbm1lbnQ6IHsgbmFtZTogJ2RldicsIGFjY291bnQ6ICcxMjM0NScsIHJlZ2lvbjogJ2hlcmUnIH0sXG4gICAgICBtZXRhZGF0YToge30sXG4gICAgfSxcbiAgICB7XG4gICAgICBuYW1lOiAnd2l0aGVycm9ycycsXG4gICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ2Vycm9ycmVzb3VyY2UnIH0sXG4gICAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZGV2JywgYWNjb3VudDogJzEyMzQ1JywgcmVnaW9uOiAnaGVyZScgfSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICcvcmVzb3VyY2UnOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogY3hhcGkuRVJST1JfTUVUQURBVEFfS0VZLFxuICAgICAgICAgICAgZGF0YTogJ3RoaXMgaXMgYW4gZXJyb3InLFxuICAgICAgICAgICAgdHJhY2U6IFtdXG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9XG4gICAgfVxuICBdXG59O1xuXG5leHBvcnQgPSB7XG4gIGFzeW5jICdkbyBub3QgdGhyb3cgd2hlbiBzZWxlY3Rpbmcgc3RhY2sgd2l0aG91dCBlcnJvcnMnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrcyA9IG5ldyBBcHBTdGFja3Moe1xuICAgICAgY29uZmlndXJhdGlvbjogbmV3IENvbmZpZ3VyYXRpb24oKSxcbiAgICAgIGF3czogbmV3IFNESygpLFxuICAgICAgc3ludGhlc2l6ZXI6IGFzeW5jICgpID0+IEZJWEVEX1JFU1VMVCxcbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBzZWxlY3RlZCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWyd3aXRob3V0ZXJyb3JzJ10sIEV4dGVuZGVkU3RhY2tTZWxlY3Rpb24uTm9uZSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5lcXVhbChzZWxlY3RlZFswXS50ZW1wbGF0ZS5yZXNvdXJjZSwgJ25vZXJyb3JyZXNvdXJjZScpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ2RvIHRocm93IHdoZW4gc2VsZWN0aW5nIHN0YWNrIHdpdGggZXJyb3JzJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFja3MgPSBuZXcgQXBwU3RhY2tzKHtcbiAgICAgIGNvbmZpZ3VyYXRpb246IG5ldyBDb25maWd1cmF0aW9uKCksXG4gICAgICBhd3M6IG5ldyBTREsoKSxcbiAgICAgIHN5bnRoZXNpemVyOiBhc3luYyAoKSA9PiBGSVhFRF9SRVNVTFQsXG4gICAgfSk7XG5cbiAgICAvLyBXSEVOXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWyd3aXRoZXJyb3JzJ10sIEV4dGVuZGVkU3RhY2tTZWxlY3Rpb24uTm9uZSk7XG4gICAgICB0ZXN0Lm9rKGZhbHNlLCAnRGlkIG5vdCBnZXQgZXhjZXB0aW9uJyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGVzdC5vaygvRm91bmQgZXJyb3JzLy50ZXN0KGUudG9TdHJpbmcoKSksICdXcm9uZyBlcnJvcicpO1xuICAgIH1cblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdyZW5hbWVzIGdldCBhcHBsaWVkIHdoZW4gc3RhY2tzIGFyZSBzZWxlY3RlZCcodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2tzID0gbmV3IEFwcFN0YWNrcyh7XG4gICAgICBjb25maWd1cmF0aW9uOiBuZXcgQ29uZmlndXJhdGlvbigpLFxuICAgICAgYXdzOiBuZXcgU0RLKCksXG4gICAgICBzeW50aGVzaXplcjogYXN5bmMgKCkgPT4gRklYRURfUkVTVUxULFxuICAgICAgcmVuYW1lczogbmV3IFJlbmFtZXMoeyB3aXRob3V0ZXJyb3JzOiAnd2l0aG91dGJhbmFuYXMnIH0pLFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHN5bnRoZWQgPSBhd2FpdCBzdGFja3Muc2VsZWN0U3RhY2tzKFsnd2l0aG91dGVycm9ycyddLCBFeHRlbmRlZFN0YWNrU2VsZWN0aW9uLk5vbmUpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoc3ludGhlZFswXS5uYW1lLCAnd2l0aG91dGJhbmFuYXMnKTtcbiAgICB0ZXN0LmVxdWFsKHN5bnRoZWRbMF0ub3JpZ2luYWxOYW1lLCAnd2l0aG91dGVycm9ycycpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ2RvZXMgbm90IHJldHVybiBub24tYXV0b0RlcGxveWVkIFN0YWNrcyB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBzZWxlY3RvcnMnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrcyA9IGFwcFN0YWNrc1dpdGgoW1xuICAgICAge1xuICAgICAgICBuYW1lOiAnTm90QXV0b0RlcGxveWVkU3RhY2snLFxuICAgICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ1Jlc291cmNlJyB9LFxuICAgICAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZGV2JywgYWNjb3VudDogJzEyMzQ1JywgcmVnaW9uOiAnaGVyZScgfSxcbiAgICAgICAgbWV0YWRhdGE6IHt9LFxuICAgICAgICBhdXRvRGVwbG95OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgc3ludGhlZCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoW10sIEV4dGVuZGVkU3RhY2tTZWxlY3Rpb24uTm9uZSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5lcXVhbChzeW50aGVkLmxlbmd0aCwgMCk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnZG9lcyByZXR1cm4gbm9uLWF1dG9EZXBsb3llZCBTdGFja3Mgd2hlbiBjYWxsZWQgd2l0aCBzZWxlY3RvcnMgbWF0Y2hpbmcgaXQnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrcyA9IGFwcFN0YWNrc1dpdGgoW1xuICAgICAge1xuICAgICAgICBuYW1lOiAnTm90QXV0b0RlcGxveWVkU3RhY2snLFxuICAgICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ1Jlc291cmNlJyB9LFxuICAgICAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZGV2JywgYWNjb3VudDogJzEyMzQ1JywgcmVnaW9uOiAnaGVyZScgfSxcbiAgICAgICAgbWV0YWRhdGE6IHt9LFxuICAgICAgICBhdXRvRGVwbG95OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgXSk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgc3ludGhlZCA9IGF3YWl0IHN0YWNrcy5zZWxlY3RTdGFja3MoWydOb3RBdXRvRGVwbG95ZWRTdGFjayddLCBFeHRlbmRlZFN0YWNrU2VsZWN0aW9uLk5vbmUpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoc3ludGhlZC5sZW5ndGgsIDEpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgXCJkb2VzIHJldHVybiBhbiBub24tYXV0b0RlcGxveWVkIFN0YWNrIHdoZW4gaXQncyBhIGRlcGVuZGVuY3kgb2YgYSBzZWxlY3RlZCBTdGFja1wiKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrcyA9IGFwcFN0YWNrc1dpdGgoW1xuICAgICAge1xuICAgICAgICBuYW1lOiAnTm90QXV0b0RlcGxveWVkU3RhY2snLFxuICAgICAgICB0ZW1wbGF0ZTogeyByZXNvdXJjZTogJ1Jlc291cmNlJyB9LFxuICAgICAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZGV2JywgYWNjb3VudDogJzEyMzQ1JywgcmVnaW9uOiAnaGVyZScgfSxcbiAgICAgICAgbWV0YWRhdGE6IHt9LFxuICAgICAgICBhdXRvRGVwbG95OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIG5hbWU6ICdBdXRvRGVwbG95ZWRTdGFjaycsXG4gICAgICAgIHRlbXBsYXRlOiB7IHJlc291cmNlOiAnUmVzb3VyY2UnIH0sXG4gICAgICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdkZXYnLCBhY2NvdW50OiAnMTIzNDUnLCByZWdpb246ICdoZXJlJyB9LFxuICAgICAgICBtZXRhZGF0YToge30sXG4gICAgICAgIGRlcGVuZHNPbjogWydOb3RBdXRvRGVwbG95ZWRTdGFjayddLFxuICAgICAgfSxcbiAgICBdKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBzeW50aGVkID0gYXdhaXQgc3RhY2tzLnNlbGVjdFN0YWNrcyhbJ0F1dG9EZXBsb3llZFN0YWNrJ10sIEV4dGVuZGVkU3RhY2tTZWxlY3Rpb24uVXBzdHJlYW0pO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoc3ludGhlZC5sZW5ndGgsIDIpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG59O1xuXG5mdW5jdGlvbiBhcHBTdGFja3NXaXRoKHN0YWNrczogY3hhcGkuU3ludGhlc2l6ZWRTdGFja1tdKTogQXBwU3RhY2tzIHtcbiAgY29uc3QgcmVzcG9uc2U6IGN4YXBpLlN5bnRoZXNpemVSZXNwb25zZSA9IHtcbiAgICB2ZXJzaW9uOiAnMScsXG4gICAgc3RhY2tzLFxuICB9O1xuICByZXR1cm4gbmV3IEFwcFN0YWNrcyh7XG4gICAgY29uZmlndXJhdGlvbjogbmV3IENvbmZpZ3VyYXRpb24oKSxcbiAgICBhd3M6IG5ldyBTREsoKSxcbiAgICBzeW50aGVzaXplcjogYXN5bmMgKCkgPT4gcmVzcG9uc2UsXG4gIH0pO1xufVxuIl19