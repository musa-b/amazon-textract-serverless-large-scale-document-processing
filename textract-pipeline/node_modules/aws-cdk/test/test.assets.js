"use strict";
const assets_1 = require("../lib/assets");
class FakeToolkit {
    constructor() {
        this.bucketUrl = 'https://bucket';
        this.bucketName = 'bucket';
    }
    async uploadIfChanged(_data, props) {
        const filename = `12345${props.s3KeySuffix}`;
        return {
            filename,
            changed: true,
            key: `${props.s3KeyPrefix}${filename}`
        };
    }
}
module.exports = {
    async 'prepare assets'(test) {
        // GIVEN
        const stack = {
            name: 'SomeStack',
            environment: {
                name: 'myenv',
                account: 'myaccount',
                region: 'myregion'
            },
            metadata: {
                '/SomeStack/SomeResource': [{
                        type: 'aws:cdk:asset',
                        data: {
                            path: __filename,
                            id: 'SomeStackSomeResource4567',
                            packaging: 'file',
                            s3BucketParameter: 'BucketParameter',
                            s3KeyParameter: 'KeyParameter'
                        },
                        trace: []
                    }]
            },
            template: {
                Resources: {
                    SomeResource: {
                        Type: 'AWS::Something::Something'
                    }
                }
            }
        };
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(stack, toolkit);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'BucketParameter', ParameterValue: 'bucket' },
            { ParameterKey: 'KeyParameter', ParameterValue: 'assets/SomeStackSomeResource4567/||12345.js' },
        ]);
        test.done();
    },
    async 'prepare assets with reuse'(test) {
        // GIVEN
        const stack = {
            name: 'SomeStack',
            environment: {
                name: 'myenv',
                account: 'myaccount',
                region: 'myregion'
            },
            metadata: {
                '/SomeStack/SomeResource': [{
                        type: 'aws:cdk:asset',
                        data: {
                            path: __filename,
                            id: 'SomeStackSomeResource4567',
                            packaging: 'file',
                            s3BucketParameter: 'BucketParameter',
                            s3KeyParameter: 'KeyParameter'
                        },
                        trace: []
                    }]
            },
            template: {
                Resources: {
                    SomeResource: {
                        Type: 'AWS::Something::Something'
                    }
                }
            }
        };
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'BucketParameter', UsePreviousValue: true },
            { ParameterKey: 'KeyParameter', UsePreviousValue: true },
        ]);
        test.done();
    },
    async 'prepare container asset with reuse'(test) {
        // GIVEN
        const stack = {
            name: 'SomeStack',
            environment: { name: 'myenv', account: 'myaccount', region: 'myregion' },
            metadata: {
                '/SomeStack/SomeResource': [{
                        type: 'aws:cdk:asset',
                        data: {
                            path: __dirname,
                            id: 'SomeStackSomeResource4567',
                            packaging: 'container-image',
                            imageNameParameter: 'asdf'
                        },
                        trace: []
                    }]
            },
            template: {
                Resources: {
                    SomeResource: {
                        Type: 'AWS::Something::Something'
                    }
                }
            }
        };
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'asdf', UsePreviousValue: true },
        ]);
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hc3NldHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LmFzc2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsMENBQThDO0FBa0k5QyxNQUFNLFdBQVc7SUFBakI7UUFDUyxjQUFTLEdBQVcsZ0JBQWdCLENBQUM7UUFDckMsZUFBVSxHQUFXLFFBQVEsQ0FBQztJQVV2QyxDQUFDO0lBUlEsS0FBSyxDQUFDLGVBQWUsQ0FBQyxLQUFVLEVBQUUsS0FBa0I7UUFDekQsTUFBTSxRQUFRLEdBQUcsUUFBUSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDN0MsT0FBTztZQUNMLFFBQVE7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLEdBQUcsRUFBRSxHQUFHLEtBQUssQ0FBQyxXQUFXLEdBQUcsUUFBUSxFQUFFO1NBQ3ZDLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUE1SUQsaUJBQVM7SUFDUCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBVTtRQUMvQixRQUFRO1FBQ1IsTUFBTSxLQUFLLEdBQXFCO1lBQzlCLElBQUksRUFBRSxXQUFXO1lBQ2pCLFdBQVcsRUFBRTtnQkFDWCxJQUFJLEVBQUUsT0FBTztnQkFDYixPQUFPLEVBQUUsV0FBVztnQkFDcEIsTUFBTSxFQUFFLFVBQVU7YUFDbkI7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IseUJBQXlCLEVBQUUsQ0FBQzt3QkFDMUIsSUFBSSxFQUFFLGVBQWU7d0JBQ3JCLElBQUksRUFBRTs0QkFDSixJQUFJLEVBQUUsVUFBVTs0QkFDaEIsRUFBRSxFQUFFLDJCQUEyQjs0QkFDL0IsU0FBUyxFQUFFLE1BQU07NEJBQ2pCLGlCQUFpQixFQUFFLGlCQUFpQjs0QkFDcEMsY0FBYyxFQUFFLGNBQWM7eUJBQ1Q7d0JBQ3ZCLEtBQUssRUFBRSxFQUFFO3FCQUNWLENBQUM7YUFDSDtZQUNELFFBQVEsRUFBRTtnQkFDUixTQUFTLEVBQUU7b0JBQ1QsWUFBWSxFQUFFO3dCQUNaLElBQUksRUFBRSwyQkFB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RUFBRSxDQUFDLDJCQUEyQixDQUFDLENBQUMsQ0FBQztRQUVwRyxPQUFPO1FBQ1AsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDckIsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLGdCQUFnQixFQUFFLElBQUksRUFBRTtTQUNqRCxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFzc2V0TWV0YWRhdGFFbnRyeSwgQ29udGFpbmVySW1hZ2VBc3NldE1ldGFkYXRhRW50cnksIFN5bnRoZXNpemVkU3RhY2sgfSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCB7IFVwbG9hZGVkLCBVcGxvYWRQcm9wcyB9IGZyb20gJy4uL2xpYic7XG5pbXBvcnQgeyBwcmVwYXJlQXNzZXRzIH0gZnJvbSAnLi4vbGliL2Fzc2V0cyc7XG5cbmV4cG9ydCA9IHtcbiAgYXN5bmMgJ3ByZXBhcmUgYXNzZXRzJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjazogU3ludGhlc2l6ZWRTdGFjayA9IHtcbiAgICAgIG5hbWU6ICdTb21lU3RhY2snLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgbmFtZTogJ215ZW52JyxcbiAgICAgICAgYWNjb3VudDogJ215YWNjb3VudCcsXG4gICAgICAgIHJlZ2lvbjogJ215cmVnaW9uJ1xuICAgICAgfSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICcvU29tZVN0YWNrL1NvbWVSZXNvdXJjZSc6IFt7XG4gICAgICAgICAgdHlwZTogJ2F3czpjZGs6YXNzZXQnLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgICAgICBpZDogJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnLFxuICAgICAgICAgICAgcGFja2FnaW5nOiAnZmlsZScsXG4gICAgICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgICAgICBzM0tleVBhcmFtZXRlcjogJ0tleVBhcmFtZXRlcidcbiAgICAgICAgICB9IGFzIEFzc2V0TWV0YWRhdGFFbnRyeSxcbiAgICAgICAgICB0cmFjZTogW11cbiAgICAgICAgfV1cbiAgICAgIH0sXG4gICAgICB0ZW1wbGF0ZToge1xuICAgICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgICBTb21lUmVzb3VyY2U6IHtcbiAgICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdG9vbGtpdCA9IG5ldyBGYWtlVG9vbGtpdCgpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBhcmFtcyA9IGF3YWl0IHByZXBhcmVBc3NldHMoc3RhY2ssIHRvb2xraXQgYXMgYW55KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmRlZXBFcXVhbChwYXJhbXMsIFtcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiAnQnVja2V0UGFyYW1ldGVyJywgUGFyYW1ldGVyVmFsdWU6ICdidWNrZXQnIH0sXG4gICAgICB7IFBhcmFtZXRlcktleTogJ0tleVBhcmFtZXRlcicsIFBhcmFtZXRlclZhbHVlOiAnYXNzZXRzL1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcvfHwxMjM0NS5qcycgfSxcbiAgICBdKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdwcmVwYXJlIGFzc2V0cyB3aXRoIHJldXNlJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzdGFjazogU3ludGhlc2l6ZWRTdGFjayA9IHtcbiAgICAgIG5hbWU6ICdTb21lU3RhY2snLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgbmFtZTogJ215ZW52JyxcbiAgICAgICAgYWNjb3VudDogJ215YWNjb3VudCcsXG4gICAgICAgIHJlZ2lvbjogJ215cmVnaW9uJ1xuICAgICAgfSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICcvU29tZVN0YWNrL1NvbWVSZXNvdXJjZSc6IFt7XG4gICAgICAgICAgdHlwZTogJ2F3czpjZGs6YXNzZXQnLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgICAgICBpZDogJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnLFxuICAgICAgICAgICAgcGFja2FnaW5nOiAnZmlsZScsXG4gICAgICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgICAgICBzM0tleVBhcmFtZXRlcjogJ0tleVBhcmFtZXRlcidcbiAgICAgICAgICB9IGFzIEFzc2V0TWV0YWRhdGFFbnRyeSxcbiAgICAgICAgICB0cmFjZTogW11cbiAgICAgICAgfV1cbiAgICAgIH0sXG4gICAgICB0ZW1wbGF0ZToge1xuICAgICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgICBTb21lUmVzb3VyY2U6IHtcbiAgICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgY29uc3QgdG9vbGtpdCA9IG5ldyBGYWtlVG9vbGtpdCgpO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHBhcmFtcyA9IGF3YWl0IHByZXBhcmVBc3NldHMoc3RhY2ssIHRvb2xraXQgYXMgYW55LCB1bmRlZmluZWQsIFsnU29tZVN0YWNrU29tZVJlc291cmNlNDU2NyddKTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmRlZXBFcXVhbChwYXJhbXMsIFtcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiAnQnVja2V0UGFyYW1ldGVyJywgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgICAgeyBQYXJhbWV0ZXJLZXk6ICdLZXlQYXJhbWV0ZXInLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgXSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAncHJlcGFyZSBjb250YWluZXIgYXNzZXQgd2l0aCByZXVzZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2sgPSB7XG4gICAgICBuYW1lOiAnU29tZVN0YWNrJyxcbiAgICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdteWVudicsIGFjY291bnQ6ICdteWFjY291bnQnLCByZWdpb246ICdteXJlZ2lvbicgfSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICcvU29tZVN0YWNrL1NvbWVSZXNvdXJjZSc6IFt7XG4gICAgICAgICAgdHlwZTogJ2F3czpjZGs6YXNzZXQnLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHBhdGg6IF9fZGlybmFtZSxcbiAgICAgICAgICAgIGlkOiAnU29tZVN0YWNrU29tZVJlc291cmNlNDU2NycsXG4gICAgICAgICAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgICAgICAgICAgaW1hZ2VOYW1lUGFyYW1ldGVyOiAnYXNkZidcbiAgICAgICAgICB9IGFzIENvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5LFxuICAgICAgICAgIHRyYWNlOiBbXVxuICAgICAgICB9XVxuICAgICAgfSxcbiAgICAgIHRlbXBsYXRlOiB7XG4gICAgICAgIFJlc291cmNlczoge1xuICAgICAgICAgIFNvbWVSZXNvdXJjZToge1xuICAgICAgICAgICAgVHlwZTogJ0FXUzo6U29tZXRoaW5nOjpTb21ldGhpbmcnXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB0b29sa2l0ID0gbmV3IEZha2VUb29sa2l0KCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcGFyYW1zID0gYXdhaXQgcHJlcGFyZUFzc2V0cyhzdGFjaywgdG9vbGtpdCBhcyBhbnksIHVuZGVmaW5lZCwgWydTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3J10pO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcywgW1xuICAgICAgeyBQYXJhbWV0ZXJLZXk6ICdhc2RmJywgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgIF0pO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH1cbn07XG5cbmNsYXNzIEZha2VUb29sa2l0IHtcbiAgcHVibGljIGJ1Y2tldFVybDogc3RyaW5nID0gJ2h0dHBzOi8vYnVja2V0JztcbiAgcHVibGljIGJ1Y2tldE5hbWU6IHN0cmluZyA9ICdidWNrZXQnO1xuXG4gIHB1YmxpYyBhc3luYyB1cGxvYWRJZkNoYW5nZWQoX2RhdGE6IGFueSwgcHJvcHM6IFVwbG9hZFByb3BzKTogUHJvbWlzZTxVcGxvYWRlZD4ge1xuICAgIGNvbnN0IGZpbGVuYW1lID0gYDEyMzQ1JHtwcm9wcy5zM0tleVN1ZmZpeH1gO1xuICAgIHJldHVybiB7XG4gICAgICBmaWxlbmFtZSxcbiAgICAgIGNoYW5nZWQ6IHRydWUsXG4gICAgICBrZXk6IGAke3Byb3BzLnMzS2V5UHJlZml4fSR7ZmlsZW5hbWV9YFxuICAgIH07XG4gIH1cbn1cbiJdfQ==