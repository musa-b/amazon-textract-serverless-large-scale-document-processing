"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const iam = require("@aws-cdk/aws-iam");
const s3n = require("@aws-cdk/aws-s3-notifications");
const cdk = require("@aws-cdk/cdk");
const policy_1 = require("./policy");
const subscription_1 = require("./subscription");
/**
 * Either a new or imported Topic
 */
class TopicBase extends cdk.Construct {
    constructor() {
        super(...arguments);
        /** Buckets permitted to send notifications to this topic */
        this.notifyingBuckets = new Set();
        /**
         * Indicates if the resource policy that allows CloudWatch events to publish
         * notifications to this topic have been added.
         */
        this.eventRuleTargetPolicyAdded = false;
    }
    /**
     * Subscribe some endpoint to this topic
     */
    subscribe(name, endpoint, protocol, rawMessageDelivery) {
        return new subscription_1.Subscription(this, name, {
            topic: this,
            endpoint,
            protocol,
            rawMessageDelivery,
        });
    }
    /**
     * Defines a subscription from this SNS topic to an SQS queue.
     *
     * The queue resource policy will be updated to allow this SNS topic to send
     * messages to the queue.
     *
     * @param name The subscription name
     * @param queue The target queue
     * @param rawMessageDelivery Enable raw message delivery
     */
    subscribeQueue(queue, rawMessageDelivery) {
        if (!cdk.Construct.isConstruct(queue)) {
            throw new Error(`The supplied Queue object must be an instance of Construct`);
        }
        const subscriptionName = this.node.id + 'Subscription';
        if (queue.node.tryFindChild(subscriptionName)) {
            throw new Error(`A subscription between the topic ${this.node.id} and the queue ${queue.node.id} already exists`);
        }
        // we use the queue name as the subscription's. there's no meaning to subscribing
        // the same queue twice on the same topic. Create subscription under *consuming*
        // construct to make sure it ends up in the correct stack in cases of cross-stack subscriptions.
        const sub = new subscription_1.Subscription(queue, subscriptionName, {
            topic: this,
            endpoint: queue.queueArn,
            protocol: subscription_1.SubscriptionProtocol.Sqs,
            rawMessageDelivery,
        });
        // add a statement to the queue resource policy which allows this topic
        // to send messages to the queue.
        queue.addToResourcePolicy(new iam.PolicyStatement()
            .addResource(queue.queueArn)
            .addAction('sqs:SendMessage')
            .addServicePrincipal('sns.amazonaws.com')
            .setCondition('ArnEquals', { 'aws:SourceArn': this.topicArn }));
        return sub;
    }
    /**
     * Defines a subscription from this SNS Topic to a Lambda function.
     *
     * The Lambda's resource policy will be updated to allow this topic to
     * invoke the function.
     *
     * @param name A name for the subscription
     * @param lambdaFunction The Lambda function to invoke
     */
    subscribeLambda(lambdaFunction) {
        if (!cdk.Construct.isConstruct(lambdaFunction)) {
            throw new Error(`The supplied lambda Function object must be an instance of Construct`);
        }
        const subscriptionName = this.node.id + 'Subscription';
        if (lambdaFunction.node.tryFindChild(subscriptionName)) {
            throw new Error(`A subscription between the topic ${this.node.id} and the lambda ${lambdaFunction.id} already exists`);
        }
        // Create subscription under *consuming* construct to make sure it ends up
        // in the correct stack in cases of cross-stack subscriptions.
        const sub = new subscription_1.Subscription(lambdaFunction, subscriptionName, {
            topic: this,
            endpoint: lambdaFunction.functionArn,
            protocol: subscription_1.SubscriptionProtocol.Lambda,
        });
        lambdaFunction.addPermission(this.node.id, {
            sourceArn: this.topicArn,
            principal: new iam.ServicePrincipal('sns.amazonaws.com'),
        });
        return sub;
    }
    /**
     * Defines a subscription from this SNS topic to an email address.
     *
     * @param name A name for the subscription
     * @param emailAddress The email address to use.
     * @param options Options for the email delivery format.
     */
    subscribeEmail(name, emailAddress, options) {
        const protocol = (options && options.json ? subscription_1.SubscriptionProtocol.EmailJson : subscription_1.SubscriptionProtocol.Email);
        return new subscription_1.Subscription(this, name, {
            topic: this,
            endpoint: emailAddress,
            protocol
        });
    }
    /**
     * Defines a subscription from this SNS topic to an http:// or https:// URL.
     *
     * @param name A name for the subscription
     * @param url The URL to invoke
     * @param rawMessageDelivery Enable raw message delivery
     */
    subscribeUrl(name, url, rawMessageDelivery) {
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            throw new Error('URL must start with either http:// or https://');
        }
        const protocol = url.startsWith('https:') ? subscription_1.SubscriptionProtocol.Https : subscription_1.SubscriptionProtocol.Http;
        return new subscription_1.Subscription(this, name, {
            topic: this,
            endpoint: url,
            protocol,
            rawMessageDelivery,
        });
    }
    /**
     * Adds a statement to the IAM resource policy associated with this topic.
     *
     * If this topic was created in this stack (`new Topic`), a topic policy
     * will be automatically created upon the first call to `addToPolicy`. If
     * the topic is improted (`Topic.import`), then this is a no-op.
     */
    addToResourcePolicy(statement) {
        if (!this.policy && this.autoCreatePolicy) {
            this.policy = new policy_1.TopicPolicy(this, 'Policy', { topics: [this] });
        }
        if (this.policy) {
            // statements must be unique, so we use the statement index.
            // potantially SIDs can change as a result of order change, but this should
            // not have an impact on the policy evaluation.
            // https://docs.aws.amazon.com/sns/latest/dg/AccessPolicyLanguage_SpecialInfo.html
            statement.describe(this.policy.document.statementCount.toString());
            this.policy.document.addStatement(statement);
        }
    }
    /**
     * Grant topic publishing permissions to the given identity
     */
    grantPublish(grantee) {
        return iam.Grant.addToPrincipalOrResource({
            grantee,
            actions: ['sns:Publish'],
            resourceArns: [this.topicArn],
            resource: this,
        });
    }
    /**
     * Returns a RuleTarget that can be used to trigger this SNS topic as a
     * result from a CloudWatch event.
     *
     * @see https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/resource-based-policies-cwe.html#sns-permissions
     */
    asEventRuleTarget(_ruleArn, _ruleId) {
        if (!this.eventRuleTargetPolicyAdded) {
            this.addToResourcePolicy(new iam.PolicyStatement()
                .addAction('sns:Publish')
                .addPrincipal(new iam.ServicePrincipal('events.amazonaws.com'))
                .addResource(this.topicArn));
            this.eventRuleTargetPolicyAdded = true;
        }
        return {
            id: this.node.id,
            arn: this.topicArn,
        };
    }
    /**
     * Allow using SNS topics as lifecycle hook targets
     */
    asLifecycleHookTarget(lifecycleHook) {
        this.grantPublish(lifecycleHook.role);
        return { notificationTargetArn: this.topicArn };
    }
    get alarmActionArn() {
        return this.topicArn;
    }
    /**
     * Implements the IBucketNotificationDestination interface, allowing topics to be used
     * as bucket notification destinations.
     *
     * @param bucketArn The ARN of the bucket sending the notifications
     * @param bucketId A unique ID of the bucket
     */
    asBucketNotificationDestination(bucketArn, bucketId) {
        // allow this bucket to sns:publish to this topic (if it doesn't already have a permission)
        if (!this.notifyingBuckets.has(bucketId)) {
            this.addToResourcePolicy(new iam.PolicyStatement()
                .addServicePrincipal('s3.amazonaws.com')
                .addAction('sns:Publish')
                .addResource(this.topicArn)
                .addCondition('ArnLike', { "aws:SourceArn": bucketArn }));
            this.notifyingBuckets.add(bucketId);
        }
        return {
            arn: this.topicArn,
            type: s3n.BucketNotificationDestinationType.Topic,
            dependencies: [this.policy] // make sure the topic policy resource is created before the notification config
        };
    }
}
exports.TopicBase = TopicBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9waWMtYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRvcGljLWJhc2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFHQSx3Q0FBeUM7QUFFekMscURBQXNEO0FBRXRELG9DQUFxQztBQUNyQyxxQ0FBdUM7QUFDdkMsaURBQW9FO0FBK0VwRTs7R0FFRztBQUNILE1BQXNCLFNBQVUsU0FBUSxHQUFHLENBQUMsU0FBUztJQUFyRDs7UUFjRSw0REFBNEQ7UUFDM0MscUJBQWdCLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUV0RDs7O1dBR0c7UUFDSywrQkFBMEIsR0FBRyxLQUFLLENBQUM7SUFxTzdDLENBQUM7SUE5TkM7O09BRUc7SUFDSSxTQUFTLENBQUMsSUFBWSxFQUFFLFFBQWdCLEVBQUUsUUFBOEIsRUFBRSxrQkFBNEI7UUFDM0csT0FBTyxJQUFJLDJCQUFZLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRTtZQUNsQyxLQUFLLEVBQUUsSUFBSTtZQUNYLFFBQVE7WUFDUixRQUFRO1lBQ1Isa0JBQWtCO1NBQ25CLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSxjQUFjLENBQUMsS0FBaUIsRUFBRSxrQkFBNEI7UUFDbkUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3JDLE1BQU0sSUFBSSxLQUFLLENBQUMsNERBQTRELENBQUMsQ0FBQztTQUMvRTtRQUVELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsY0FBYyxDQUFDO1FBQ3ZELElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUM3QyxNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsa0JBQWtCLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBaUIsQ0FB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QVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUU1RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JDO1FBRUQsT0FBTztZQUNMLEdBQUcsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUNsQixJQUFJLEVBQUUsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLEtBQUs7WUFDakQsWUFBWSxFQUFFLENBQUUsSUFBSSxDQUFDLE1BQU8sQ0FBRSxDQUFDLGdGQUFnRjtTQUNoSCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBMVBELDhCQTBQQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhdXRvc2NhbGluZ19hcGkgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtYXV0b3NjYWxpbmctYXBpJyk7XG5pbXBvcnQgY2xvdWR3YXRjaCA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1jbG91ZHdhdGNoJyk7XG5pbXBvcnQgZXZlbnRzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWV2ZW50cycpO1xuaW1wb3J0IGlhbSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1pYW0nKTtcbmltcG9ydCBsYW1iZGEgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtbGFtYmRhJyk7XG5pbXBvcnQgczNuID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXMzLW5vdGlmaWNhdGlvbnMnKTtcbmltcG9ydCBzcXMgPSByZXF1aXJlKCdAYXdzLWNkay9hd3Mtc3FzJyk7XG5pbXBvcnQgY2RrID0gcmVxdWlyZSgnQGF3cy1jZGsvY2RrJyk7XG5pbXBvcnQgeyBUb3BpY1BvbGljeSB9IGZyb20gJy4vcG9saWN5JztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgU3Vic2NyaXB0aW9uUHJvdG9jb2wgfSBmcm9tICcuL3N1YnNjcmlwdGlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVRvcGljIGV4dGVuZHNcbiAgY2RrLklDb25zdHJ1Y3QsXG4gIGV2ZW50cy5JRXZlbnRSdWxlVGFyZ2V0LFxuICBjbG91ZHdhdGNoLklBbGFybUFjdGlvbixcbiAgczNuLklCdWNrZXROb3RpZmljYXRpb25EZXN0aW5hdGlvbixcbiAgYXV0b3NjYWxpbmdfYXBpLklMaWZlY3ljbGVIb29rVGFyZ2V0IHtcblxuICByZWFkb25seSB0b3BpY0Fybjogc3RyaW5nO1xuXG4gIHJlYWRvbmx5IHRvcGljTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBFeHBvcnQgdGhpcyBUb3BpY1xuICAgKi9cbiAgZXhwb3J0KCk6IFRvcGljSW1wb3J0UHJvcHM7XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSBzb21lIGVuZHBvaW50IHRvIHRoaXMgdG9waWNcbiAgICovXG4gIHN1YnNjcmliZShuYW1lOiBzdHJpbmcsIGVuZHBvaW50OiBzdHJpbmcsIHByb3RvY29sOiBTdWJzY3JpcHRpb25Qcm90b2NvbCwgcmF3TWVzc2FnZURlbGl2ZXJ5PzogYm9vbGVhbik6IFN1YnNjcmlwdGlvbjtcblxuICAvKipcbiAgICogRGVmaW5lcyBhIHN1YnNjcmlwdGlvbiBmcm9tIHRoaXMgU05TIHRvcGljIHRvIGFuIFNRUyBxdWV1ZS5cbiAgICpcbiAgICogVGhlIHF1ZXVlIHJlc291cmNlIHBvbGljeSB3aWxsIGJlIHVwZGF0ZWQgdG8gYWxsb3cgdGhpcyBTTlMgdG9waWMgdG8gc2VuZFxuICAgKiBtZXNzYWdlcyB0byB0aGUgcXVldWUuXG4gICAqXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBzdWJzY3JpcHRpb24gbmFtZVxuICAgKiBAcGFyYW0gcXVldWUgVGhlIHRhcmdldCBxdWV1ZVxuICAgKiBAcGFyYW0gcmF3TWVzc2FnZURlbGl2ZXJ5IEVuYWJsZSByYXcgbWVzc2FnZSBkZWxpdmVyeVxuICAgKi9cbiAgc3Vic2NyaWJlUXVldWUocXVldWU6IHNxcy5JUXVldWUsIHJhd01lc3NhZ2VEZWxpdmVyeT86IGJvb2xlYW4pOiBTdWJzY3JpcHRpb247XG5cbiAgLyoqXG4gICAqIERlZmluZXMgYSBzdWJzY3JpcHRpb24gZnJvbSB0aGlzIFNOUyBUb3BpYyB0byBhIExhbWJkYSBmdW5jdGlvbi5cbiAgICpcbiAgICogVGhlIExhbWJkYSdzIHJlc291cmNlIHBvbGljeSB3aWxsIGJlIHVwZGF0ZWQgdG8gYWxsb3cgdGhpcyB0b3BpYyB0b1xuICAgKiBpbnZva2UgdGhlIGZ1bmN0aW9uLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBBIG5hbWUgZm9yIHRoZSBzdWJzY3JpcHRpb25cbiAgICogQHBhcmFtIGxhbWJkYUZ1bmN0aW9uIFRoZSBMYW1iZGEgZnVuY3Rpb24gdG8gaW52b2tlXG4gICAqL1xuICBzdWJzY3JpYmVMYW1iZGEobGFtYmRhRnVuY3Rpb246IGxhbWJkYS5JRnVuY3Rpb24pOiBTdWJzY3JpcHRpb247XG5cbiAgLyoqXG4gICAqIERlZmluZXMgYSBzdWJzY3JpcHRpb24gZnJvbSB0aGlzIFNOUyB0b3BpYyB0byBhbiBlbWFpbCBhZGRyZXNzLlxuICAgKlxuICAgKiBAcGFyYW0gbmFtZSBBIG5hbWUgZm9yIHRoZSBzdWJzY3JpcHRpb25cbiAgICogQHBhcmFtIGVtYWlsQWRkcmVzcyBUaGUgZW1haWwgYWRkcmVzcyB0byB1c2UuXG4gICAqIEBwYXJhbSBqc29uRm9ybWF0IFRydWUgaWYgdGhlIGVtYWlsIGNvbnRlbnQgc2hvdWxkIGJlIGluIEpTT04gZm9ybWF0IChkZWZhdWx0IGlzIGZhbHNlKS5cbiAgICovXG4gIHN1YnNjcmliZUVtYWlsKG5hbWU6IHN0cmluZywgZW1haWxBZGRyZXNzOiBzdHJpbmcsIG9wdGlvbnM/OiBFbWFpbFN1YnNjcmlwdGlvbk9wdGlvbnMpOiBTdWJzY3JpcHRpb247XG5cbiAgLyoqXG4gICAqIERlZmluZXMgYSBzdWJzY3JpcHRpb24gZnJvbSB0aGlzIFNOUyB0b3BpYyB0byBhbiBodHRwOi8vIG9yIGh0dHBzOi8vIFVSTC5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgQSBuYW1lIGZvciB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIEBwYXJhbSB1cmwgVGhlIFVSTCB0byBpbnZva2VcbiAgICogQHBhcmFtIHJhd01lc3NhZ2VEZWxpdmVyeSBFbmFibGUgcmF3IG1lc3NhZ2UgZGVsaXZlcnlcbiAgICovXG4gIHN1YnNjcmliZVVybChuYW1lOiBzdHJpbmcsIHVybDogc3RyaW5nLCByYXdNZXNzYWdlRGVsaXZlcnk/OiBib29sZWFuKTogU3Vic2NyaXB0aW9uO1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgc3RhdGVtZW50IHRvIHRoZSBJQU0gcmVzb3VyY2UgcG9saWN5IGFzc29jaWF0ZWQgd2l0aCB0aGlzIHRvcGljLlxuICAgKlxuICAgKiBJZiB0aGlzIHRvcGljIHdhcyBjcmVhdGVkIGluIHRoaXMgc3RhY2sgKGBuZXcgVG9waWNgKSwgYSB0b3BpYyBwb2xpY3lcbiAgICogd2lsbCBiZSBhdXRvbWF0aWNhbGx5IGNyZWF0ZWQgdXBvbiB0aGUgZmlyc3QgY2FsbCB0byBgYWRkVG9Qb2xpY3lgLiBJZlxuICAgKiB0aGUgdG9waWMgaXMgaW1wcm90ZWQgKGBUb3BpYy5pbXBvcnRgKSwgdGhlbiB0aGlzIGlzIGEgbm8tb3AuXG4gICAqL1xuICBhZGRUb1Jlc291cmNlUG9saWN5KHN0YXRlbWVudDogaWFtLlBvbGljeVN0YXRlbWVudCk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIEdyYW50IHRvcGljIHB1Ymxpc2hpbmcgcGVybWlzc2lvbnMgdG8gdGhlIGdpdmVuIGlkZW50aXR5XG4gICAqL1xuICBncmFudFB1Ymxpc2goaWRlbnRpdHk6IGlhbS5JR3JhbnRhYmxlKTogaWFtLkdyYW50O1xufVxuXG4vKipcbiAqIEVpdGhlciBhIG5ldyBvciBpbXBvcnRlZCBUb3BpY1xuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVG9waWNCYXNlIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCBpbXBsZW1lbnRzIElUb3BpYyB7XG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSB0b3BpY0Fybjogc3RyaW5nO1xuXG4gIHB1YmxpYyBhYnN0cmFjdCByZWFkb25seSB0b3BpY05hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogQ29udHJvbHMgYXV0b21hdGljIGNyZWF0aW9uIG9mIHBvbGljeSBvYmplY3RzLlxuICAgKlxuICAgKiBTZXQgYnkgc3ViY2xhc3Nlcy5cbiAgICovXG4gIHByb3RlY3RlZCBhYnN0cmFjdCByZWFkb25seSBhdXRvQ3JlYXRlUG9saWN5OiBib29sZWFuO1xuXG4gIHByaXZhdGUgcG9saWN5PzogVG9waWNQb2xpY3k7XG5cbiAgLyoqIEJ1Y2tldHMgcGVybWl0dGVkIHRvIHNlbmQgbm90aWZpY2F0aW9ucyB0byB0aGlzIHRvcGljICovXG4gIHByaXZhdGUgcmVhZG9ubHkgbm90aWZ5aW5nQnVja2V0cyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgaWYgdGhlIHJlc291cmNlIHBvbGljeSB0aGF0IGFsbG93cyBDbG91ZFdhdGNoIGV2ZW50cyB0byBwdWJsaXNoXG4gICAqIG5vdGlmaWNhdGlvbnMgdG8gdGhpcyB0b3BpYyBoYXZlIGJlZW4gYWRkZWQuXG4gICAqL1xuICBwcml2YXRlIGV2ZW50UnVsZVRhcmdldFBvbGljeUFkZGVkID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEV4cG9ydCB0aGlzIFRvcGljXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgZXhwb3J0KCk6IFRvcGljSW1wb3J0UHJvcHM7XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZSBzb21lIGVuZHBvaW50IHRvIHRoaXMgdG9waWNcbiAgICovXG4gIHB1YmxpYyBzdWJzY3JpYmUobmFtZTogc3RyaW5nLCBlbmRwb2ludDogc3RyaW5nLCBwcm90b2NvbDogU3Vic2NyaXB0aW9uUHJvdG9jb2wsIHJhd01lc3NhZ2VEZWxpdmVyeT86IGJvb2xlYW4pOiBTdWJzY3JpcHRpb24ge1xuICAgIHJldHVybiBuZXcgU3Vic2NyaXB0aW9uKHRoaXMsIG5hbWUsIHtcbiAgICAgIHRvcGljOiB0aGlzLFxuICAgICAgZW5kcG9pbnQsXG4gICAgICBwcm90b2NvbCxcbiAgICAgIHJhd01lc3NhZ2VEZWxpdmVyeSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhpcyBTTlMgdG9waWMgdG8gYW4gU1FTIHF1ZXVlLlxuICAgKlxuICAgKiBUaGUgcXVldWUgcmVzb3VyY2UgcG9saWN5IHdpbGwgYmUgdXBkYXRlZCB0byBhbGxvdyB0aGlzIFNOUyB0b3BpYyB0byBzZW5kXG4gICAqIG1lc3NhZ2VzIHRvIHRoZSBxdWV1ZS5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgVGhlIHN1YnNjcmlwdGlvbiBuYW1lXG4gICAqIEBwYXJhbSBxdWV1ZSBUaGUgdGFyZ2V0IHF1ZXVlXG4gICAqIEBwYXJhbSByYXdNZXNzYWdlRGVsaXZlcnkgRW5hYmxlIHJhdyBtZXNzYWdlIGRlbGl2ZXJ5XG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlUXVldWUocXVldWU6IHNxcy5JUXVldWUsIHJhd01lc3NhZ2VEZWxpdmVyeT86IGJvb2xlYW4pOiBTdWJzY3JpcHRpb24ge1xuICAgIGlmICghY2RrLkNvbnN0cnVjdC5pc0NvbnN0cnVjdChxdWV1ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHN1cHBsaWVkIFF1ZXVlIG9iamVjdCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIENvbnN0cnVjdGApO1xuICAgIH1cblxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbk5hbWUgPSB0aGlzLm5vZGUuaWQgKyAnU3Vic2NyaXB0aW9uJztcbiAgICBpZiAocXVldWUubm9kZS50cnlGaW5kQ2hpbGQoc3Vic2NyaXB0aW9uTmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQSBzdWJzY3JpcHRpb24gYmV0d2VlbiB0aGUgdG9waWMgJHt0aGlzLm5vZGUuaWR9IGFuZCB0aGUgcXVldWUgJHtxdWV1ZS5ub2RlLmlkfSBhbHJlYWR5IGV4aXN0c2ApO1xuICAgIH1cblxuICAgIC8vIHdlIHVzZSB0aGUgcXVldWUgbmFtZSBhcyB0aGUgc3Vic2NyaXB0aW9uJ3MuIHRoZXJlJ3Mgbm8gbWVhbmluZyB0byBzdWJzY3JpYmluZ1xuICAgIC8vIHRoZSBzYW1lIHF1ZXVlIHR3aWNlIG9uIHRoZSBzYW1lIHRvcGljLiBDcmVhdGUgc3Vic2NyaXB0aW9uIHVuZGVyICpjb25zdW1pbmcqXG4gICAgLy8gY29uc3RydWN0IHRvIG1ha2Ugc3VyZSBpdCBlbmRzIHVwIGluIHRoZSBjb3JyZWN0IHN0YWNrIGluIGNhc2VzIG9mIGNyb3NzLXN0YWNrIHN1YnNjcmlwdGlvbnMuXG4gICAgY29uc3Qgc3ViID0gbmV3IFN1YnNjcmlwdGlvbihxdWV1ZSwgc3Vic2NyaXB0aW9uTmFtZSwge1xuICAgICAgdG9waWM6IHRoaXMsXG4gICAgICBlbmRwb2ludDogcXVldWUucXVldWVBcm4sXG4gICAgICBwcm90b2NvbDogU3Vic2NyaXB0aW9uUHJvdG9jb2wuU3FzLFxuICAgICAgcmF3TWVzc2FnZURlbGl2ZXJ5LFxuICAgIH0pO1xuXG4gICAgLy8gYWRkIGEgc3RhdGVtZW50IHRvIHRoZSBxdWV1ZSByZXNvdXJjZSBwb2xpY3kgd2hpY2ggYWxsb3dzIHRoaXMgdG9waWNcbiAgICAvLyB0byBzZW5kIG1lc3NhZ2VzIHRvIHRoZSBxdWV1ZS5cbiAgICBxdWV1ZS5hZGRUb1Jlc291cmNlUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KClcbiAgICAgIC5hZGRSZXNvdXJjZShxdWV1ZS5xdWV1ZUFybilcbiAgICAgIC5hZGRBY3Rpb24oJ3NxczpTZW5kTWVzc2FnZScpXG4gICAgICAuYWRkU2VydmljZVByaW5jaXBhbCgnc25zLmFtYXpvbmF3cy5jb20nKVxuICAgICAgLnNldENvbmRpdGlvbignQXJuRXF1YWxzJywgeyAnYXdzOlNvdXJjZUFybic6IHRoaXMudG9waWNBcm4gfSkpO1xuXG4gICAgcmV0dXJuIHN1YjtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhpcyBTTlMgVG9waWMgdG8gYSBMYW1iZGEgZnVuY3Rpb24uXG4gICAqXG4gICAqIFRoZSBMYW1iZGEncyByZXNvdXJjZSBwb2xpY3kgd2lsbCBiZSB1cGRhdGVkIHRvIGFsbG93IHRoaXMgdG9waWMgdG9cbiAgICogaW52b2tlIHRoZSBmdW5jdGlvbi5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgQSBuYW1lIGZvciB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIEBwYXJhbSBsYW1iZGFGdW5jdGlvbiBUaGUgTGFtYmRhIGZ1bmN0aW9uIHRvIGludm9rZVxuICAgKi9cbiAgcHVibGljIHN1YnNjcmliZUxhbWJkYShsYW1iZGFGdW5jdGlvbjogbGFtYmRhLklGdW5jdGlvbik6IFN1YnNjcmlwdGlvbiB7XG4gICAgaWYgKCFjZGsuQ29uc3RydWN0LmlzQ29uc3RydWN0KGxhbWJkYUZ1bmN0aW9uKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3VwcGxpZWQgbGFtYmRhIEZ1bmN0aW9uIG9iamVjdCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIENvbnN0cnVjdGApO1xuICAgIH1cblxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbk5hbWUgPSB0aGlzLm5vZGUuaWQgKyAnU3Vic2NyaXB0aW9uJztcblxuICAgIGlmIChsYW1iZGFGdW5jdGlvbi5ub2RlLnRyeUZpbmRDaGlsZChzdWJzY3JpcHRpb25OYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBIHN1YnNjcmlwdGlvbiBiZXR3ZWVuIHRoZSB0b3BpYyAke3RoaXMubm9kZS5pZH0gYW5kIHRoZSBsYW1iZGEgJHtsYW1iZGFGdW5jdGlvbi5pZH0gYWxyZWFkeSBleGlzdHNgKTtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgc3Vic2NyaXB0aW9uIHVuZGVyICpjb25zdW1pbmcqIGNvbnN0cnVjdCB0byBtYWtlIHN1cmUgaXQgZW5kcyB1cFxuICAgIC8vIGluIHRoZSBjb3JyZWN0IHN0YWNrIGluIGNhc2VzIG9mIGNyb3NzLXN0YWNrIHN1YnNjcmlwdGlvbnMuXG4gICAgY29uc3Qgc3ViID0gbmV3IFN1YnNjcmlwdGlvbihsYW1iZGFGdW5jdGlvbiwgc3Vic2NyaXB0aW9uTmFtZSwge1xuICAgICAgdG9waWM6IHRoaXMsXG4gICAgICBlbmRwb2ludDogbGFtYmRhRnVuY3Rpb24uZnVuY3Rpb25Bcm4sXG4gICAgICBwcm90b2NvbDogU3Vic2NyaXB0aW9uUHJvdG9jb2wuTGFtYmRhLFxuICAgIH0pO1xuXG4gICAgbGFtYmRhRnVuY3Rpb24uYWRkUGVybWlzc2lvbih0aGlzLm5vZGUuaWQsIHtcbiAgICAgIHNvdXJjZUFybjogdGhpcy50b3BpY0FybixcbiAgICAgIHByaW5jaXBhbDogbmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdzbnMuYW1hem9uYXdzLmNvbScpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHN1YjtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhpcyBTTlMgdG9waWMgdG8gYW4gZW1haWwgYWRkcmVzcy5cbiAgICpcbiAgICogQHBhcmFtIG5hbWUgQSBuYW1lIGZvciB0aGUgc3Vic2NyaXB0aW9uXG4gICAqIEBwYXJhbSBlbWFpbEFkZHJlc3MgVGhlIGVtYWlsIGFkZHJlc3MgdG8gdXNlLlxuICAgKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25zIGZvciB0aGUgZW1haWwgZGVsaXZlcnkgZm9ybWF0LlxuICAgKi9cbiAgcHVibGljIHN1YnNjcmliZUVtYWlsKG5hbWU6IHN0cmluZywgZW1haWxBZGRyZXNzOiBzdHJpbmcsIG9wdGlvbnM/OiBFbWFpbFN1YnNjcmlwdGlvbk9wdGlvbnMpOiBTdWJzY3JpcHRpb24ge1xuICAgIGNvbnN0IHByb3RvY29sID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5qc29uID8gU3Vic2NyaXB0aW9uUHJvdG9jb2wuRW1haWxKc29uIDogU3Vic2NyaXB0aW9uUHJvdG9jb2wuRW1haWwpO1xuXG4gICAgcmV0dXJuIG5ldyBTdWJzY3JpcHRpb24odGhpcywgbmFtZSwge1xuICAgICAgdG9waWM6IHRoaXMsXG4gICAgICBlbmRwb2ludDogZW1haWxBZGRyZXNzLFxuICAgICAgcHJvdG9jb2xcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhpcyBTTlMgdG9waWMgdG8gYW4gaHR0cDovLyBvciBodHRwczovLyBVUkwuXG4gICAqXG4gICAqIEBwYXJhbSBuYW1lIEEgbmFtZSBmb3IgdGhlIHN1YnNjcmlwdGlvblxuICAgKiBAcGFyYW0gdXJsIFRoZSBVUkwgdG8gaW52b2tlXG4gICAqIEBwYXJhbSByYXdNZXNzYWdlRGVsaXZlcnkgRW5hYmxlIHJhdyBtZXNzYWdlIGRlbGl2ZXJ5XG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlVXJsKG5hbWU6IHN0cmluZywgdXJsOiBzdHJpbmcsIHJhd01lc3NhZ2VEZWxpdmVyeT86IGJvb2xlYW4pOiBTdWJzY3JpcHRpb24ge1xuICAgIGlmICghdXJsLnN0YXJ0c1dpdGgoJ2h0dHA6Ly8nKSAmJiAhdXJsLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVVJMIG11c3Qgc3RhcnQgd2l0aCBlaXRoZXIgaHR0cDovLyBvciBodHRwczovLycpO1xuICAgIH1cblxuICAgIGNvbnN0IHByb3RvY29sID0gdXJsLnN0YXJ0c1dpdGgoJ2h0dHBzOicpID8gU3Vic2NyaXB0aW9uUHJvdG9jb2wuSHR0cHMgOiBTdWJzY3JpcHRpb25Qcm90b2NvbC5IdHRwO1xuXG4gICAgcmV0dXJuIG5ldyBTdWJzY3JpcHRpb24odGhpcywgbmFtZSwge1xuICAgICAgdG9waWM6IHRoaXMsXG4gICAgICBlbmRwb2ludDogdXJsLFxuICAgICAgcHJvdG9jb2wsXG4gICAgICByYXdNZXNzYWdlRGVsaXZlcnksXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN0YXRlbWVudCB0byB0aGUgSUFNIHJlc291cmNlIHBvbGljeSBhc3NvY2lhdGVkIHdpdGggdGhpcyB0b3BpYy5cbiAgICpcbiAgICogSWYgdGhpcyB0b3BpYyB3YXMgY3JlYXRlZCBpbiB0aGlzIHN0YWNrIChgbmV3IFRvcGljYCksIGEgdG9waWMgcG9saWN5XG4gICAqIHdpbGwgYmUgYXV0b21hdGljYWxseSBjcmVhdGVkIHVwb24gdGhlIGZpcnN0IGNhbGwgdG8gYGFkZFRvUG9saWN5YC4gSWZcbiAgICogdGhlIHRvcGljIGlzIGltcHJvdGVkIChgVG9waWMuaW1wb3J0YCksIHRoZW4gdGhpcyBpcyBhIG5vLW9wLlxuICAgKi9cbiAgcHVibGljIGFkZFRvUmVzb3VyY2VQb2xpY3koc3RhdGVtZW50OiBpYW0uUG9saWN5U3RhdGVtZW50KSB7XG4gICAgaWYgKCF0aGlzLnBvbGljeSAmJiB0aGlzLmF1dG9DcmVhdGVQb2xpY3kpIHtcbiAgICAgIHRoaXMucG9saWN5ID0gbmV3IFRvcGljUG9saWN5KHRoaXMsICdQb2xpY3knLCB7IHRvcGljczogWyB0aGlzIF0gfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucG9saWN5KSB7XG4gICAgICAvLyBzdGF0ZW1lbnRzIG11c3QgYmUgdW5pcXVlLCBzbyB3ZSB1c2UgdGhlIHN0YXRlbWVudCBpbmRleC5cbiAgICAgIC8vIHBvdGFudGlhbGx5IFNJRHMgY2FuIGNoYW5nZSBhcyBhIHJlc3VsdCBvZiBvcmRlciBjaGFuZ2UsIGJ1dCB0aGlzIHNob3VsZFxuICAgICAgLy8gbm90IGhhdmUgYW4gaW1wYWN0IG9uIHRoZSBwb2xpY3kgZXZhbHVhdGlvbi5cbiAgICAgIC8vIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9zbnMvbGF0ZXN0L2RnL0FjY2Vzc1BvbGljeUxhbmd1YWdlX1NwZWNpYWxJbmZvLmh0bWxcbiAgICAgIHN0YXRlbWVudC5kZXNjcmliZSh0aGlzLnBvbGljeS5kb2N1bWVudC5zdGF0ZW1lbnRDb3VudC50b1N0cmluZygpKTtcbiAgICAgIHRoaXMucG9saWN5LmRvY3VtZW50LmFkZFN0YXRlbWVudChzdGF0ZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFudCB0b3BpYyBwdWJsaXNoaW5nIHBlcm1pc3Npb25zIHRvIHRoZSBnaXZlbiBpZGVudGl0eVxuICAgKi9cbiAgcHVibGljIGdyYW50UHVibGlzaChncmFudGVlOiBpYW0uSUdyYW50YWJsZSkge1xuICAgIHJldHVybiBpYW0uR3JhbnQuYWRkVG9QcmluY2lwYWxPclJlc291cmNlKHtcbiAgICAgIGdyYW50ZWUsXG4gICAgICBhY3Rpb25zOiBbJ3NuczpQdWJsaXNoJ10sXG4gICAgICByZXNvdXJjZUFybnM6IFt0aGlzLnRvcGljQXJuXSxcbiAgICAgIHJlc291cmNlOiB0aGlzLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBSdWxlVGFyZ2V0IHRoYXQgY2FuIGJlIHVzZWQgdG8gdHJpZ2dlciB0aGlzIFNOUyB0b3BpYyBhcyBhXG4gICAqIHJlc3VsdCBmcm9tIGEgQ2xvdWRXYXRjaCBldmVudC5cbiAgICpcbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uQ2xvdWRXYXRjaC9sYXRlc3QvZXZlbnRzL3Jlc291cmNlLWJhc2VkLXBvbGljaWVzLWN3ZS5odG1sI3Nucy1wZXJtaXNzaW9uc1xuICAgKi9cbiAgcHVibGljIGFzRXZlbnRSdWxlVGFyZ2V0KF9ydWxlQXJuOiBzdHJpbmcsIF9ydWxlSWQ6IHN0cmluZyk6IGV2ZW50cy5FdmVudFJ1bGVUYXJnZXRQcm9wcyB7XG4gICAgaWYgKCF0aGlzLmV2ZW50UnVsZVRhcmdldFBvbGljeUFkZGVkKSB7XG4gICAgICB0aGlzLmFkZFRvUmVzb3VyY2VQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKVxuICAgICAgICAuYWRkQWN0aW9uKCdzbnM6UHVibGlzaCcpXG4gICAgICAgIC5hZGRQcmluY2lwYWwobmV3IGlhbS5TZXJ2aWNlUHJpbmNpcGFsKCdldmVudHMuYW1hem9uYXdzLmNvbScpKVxuICAgICAgICAuYWRkUmVzb3VyY2UodGhpcy50b3BpY0FybikpO1xuXG4gICAgICB0aGlzLmV2ZW50UnVsZVRhcmdldFBvbGljeUFkZGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaWQ6IHRoaXMubm9kZS5pZCxcbiAgICAgIGFybjogdGhpcy50b3BpY0FybixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEFsbG93IHVzaW5nIFNOUyB0b3BpY3MgYXMgbGlmZWN5Y2xlIGhvb2sgdGFyZ2V0c1xuICAgKi9cbiAgcHVibGljIGFzTGlmZWN5Y2xlSG9va1RhcmdldChsaWZlY3ljbGVIb29rOiBhdXRvc2NhbGluZ19hcGkuSUxpZmVjeWNsZUhvb2spOiBhdXRvc2NhbGluZ19hcGkuTGlmZWN5Y2xlSG9va1RhcmdldFByb3BzIHtcbiAgICB0aGlzLmdyYW50UHVibGlzaChsaWZlY3ljbGVIb29rLnJvbGUpO1xuICAgIHJldHVybiB7IG5vdGlmaWNhdGlvblRhcmdldEFybjogdGhpcy50b3BpY0FybiB9O1xuICB9XG5cbiAgcHVibGljIGdldCBhbGFybUFjdGlvbkFybigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnRvcGljQXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIEltcGxlbWVudHMgdGhlIElCdWNrZXROb3RpZmljYXRpb25EZXN0aW5hdGlvbiBpbnRlcmZhY2UsIGFsbG93aW5nIHRvcGljcyB0byBiZSB1c2VkXG4gICAqIGFzIGJ1Y2tldCBub3RpZmljYXRpb24gZGVzdGluYXRpb25zLlxuICAgKlxuICAgKiBAcGFyYW0gYnVja2V0QXJuIFRoZSBBUk4gb2YgdGhlIGJ1Y2tldCBzZW5kaW5nIHRoZSBub3RpZmljYXRpb25zXG4gICAqIEBwYXJhbSBidWNrZXRJZCBBIHVuaXF1ZSBJRCBvZiB0aGUgYnVja2V0XG4gICAqL1xuICBwdWJsaWMgYXNCdWNrZXROb3RpZmljYXRpb25EZXN0aW5hdGlvbihidWNrZXRBcm46IHN0cmluZywgYnVja2V0SWQ6IHN0cmluZyk6IHMzbi5CdWNrZXROb3RpZmljYXRpb25EZXN0aW5hdGlvblByb3BzIHtcbiAgICAvLyBhbGxvdyB0aGlzIGJ1Y2tldCB0byBzbnM6cHVibGlzaCB0byB0aGlzIHRvcGljIChpZiBpdCBkb2Vzbid0IGFscmVhZHkgaGF2ZSBhIHBlcm1pc3Npb24pXG4gICAgaWYgKCF0aGlzLm5vdGlmeWluZ0J1Y2tldHMuaGFzKGJ1Y2tldElkKSkge1xuXG4gICAgICB0aGlzLmFkZFRvUmVzb3VyY2VQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoKVxuICAgICAgICAuYWRkU2VydmljZVByaW5jaXBhbCgnczMuYW1hem9uYXdzLmNvbScpXG4gICAgICAgIC5hZGRBY3Rpb24oJ3NuczpQdWJsaXNoJylcbiAgICAgICAgLmFkZFJlc291cmNlKHRoaXMudG9waWNBcm4pXG4gICAgICAgIC5hZGRDb25kaXRpb24oJ0Fybkxpa2UnLCB7IFwiYXdzOlNvdXJjZUFyblwiOiBidWNrZXRBcm4gfSkpO1xuXG4gICAgICB0aGlzLm5vdGlmeWluZ0J1Y2tldHMuYWRkKGJ1Y2tldElkKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXJuOiB0aGlzLnRvcGljQXJuLFxuICAgICAgdHlwZTogczNuLkJ1Y2tldE5vdGlmaWNhdGlvbkRlc3RpbmF0aW9uVHlwZS5Ub3BpYyxcbiAgICAgIGRlcGVuZGVuY2llczogWyB0aGlzLnBvbGljeSEgXSAvLyBtYWtlIHN1cmUgdGhlIHRvcGljIHBvbGljeSByZXNvdXJjZSBpcyBjcmVhdGVkIGJlZm9yZSB0aGUgbm90aWZpY2F0aW9uIGNvbmZpZ1xuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBSZWZlcmVuY2UgdG8gYW4gZXh0ZXJuYWwgdG9waWMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgVG9waWNJbXBvcnRQcm9wcyB7XG4gIHJlYWRvbmx5IHRvcGljQXJuOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHRvcGljTmFtZTogc3RyaW5nO1xufVxuXG4vKipcbiAqIE9wdGlvbnMgZm9yIGVtYWlsIHN1YnNjcmlwdGlvbnMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRW1haWxTdWJzY3JpcHRpb25PcHRpb25zIHtcbiAgLyoqXG4gICAqIEluZGljYXRlcyBpZiB0aGUgZnVsbCBub3RpZmljYXRpb24gSlNPTiBzaG91bGQgYmUgc2VudCB0byB0aGUgZW1haWxcbiAgICogYWRkcmVzcyBvciBqdXN0IHRoZSBtZXNzYWdlIHRleHQuXG4gICAqXG4gICAqIEBkZWZhdWx0IE1lc3NhZ2UgdGV4dCAoZmFsc2UpXG4gICAqL1xuICByZWFkb25seSBqc29uPzogYm9vbGVhbjtcbn1cbiJdfQ==