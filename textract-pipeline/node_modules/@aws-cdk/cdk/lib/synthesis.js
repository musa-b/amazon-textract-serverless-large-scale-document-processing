"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const fs = require("fs");
const os = require("os");
const path = require("path");
const construct_1 = require("./construct");
const runtime_info_1 = require("./runtime-info");
const util_1 = require("./util");
class Synthesizer {
    synthesize(root, options = {}) {
        const session = new SynthesisSession(options);
        // the three holy phases of synthesis: prepare, validate and synthesize
        // prepare
        root.node.prepareTree();
        // validate
        const validate = options.skipValidation === undefined ? true : !options.skipValidation;
        if (validate) {
            const errors = root.node.validateTree();
            if (errors.length > 0) {
                const errorList = errors.map(e => `[${e.source.node.path}] ${e.message}`).join('\n  ');
                throw new Error(`Validation failed with the following errors:\n  ${errorList}`);
            }
        }
        // synthesize (leaves first)
        for (const c of root.node.findAll(construct_1.ConstructOrder.PostOrder)) {
            if (SynthesisSession.isSynthesizable(c)) {
                c.synthesize(session);
            }
        }
        // write session manifest and lock store
        session.close(options);
        return session;
    }
}
exports.Synthesizer = Synthesizer;
class SynthesisSession {
    constructor(options) {
        this.artifacts = {};
        this.buildSteps = {};
        this.store = options.store || new InMemoryStore();
    }
    /**
     * @returns true if `obj` implements `ISynthesizable`.
     */
    static isSynthesizable(obj) {
        return 'synthesize' in obj;
    }
    get manifest() {
        if (!this._manifest) {
            throw new Error(`Cannot read assembly manifest before the session has been finalized`);
        }
        return this._manifest;
    }
    addArtifact(id, artifact) {
        cxapi.validateArtifact(artifact);
        this.artifacts[id] = util_1.filterUndefined(artifact);
    }
    tryGetArtifact(id) {
        return this.artifacts[id];
    }
    getArtifact(id) {
        const artifact = this.tryGetArtifact(id);
        if (!artifact) {
            throw new Error(`Cannot find artifact ${id}`);
        }
        return artifact;
    }
    addBuildStep(id, step) {
        if (id in this.buildSteps) {
            throw new Error(`Build step ${id} already exists`);
        }
        this.buildSteps[id] = util_1.filterUndefined(step);
    }
    close(options = {}) {
        const legacyManifest = options.legacyManifest !== undefined ? options.legacyManifest : false;
        const runtimeInfo = options.runtimeInformation !== undefined ? options.runtimeInformation : true;
        const manifest = this._manifest = util_1.filterUndefined({
            version: cxapi.PROTO_RESPONSE_VERSION,
            artifacts: this.artifacts,
            runtime: runtimeInfo ? runtime_info_1.collectRuntimeInformation() : undefined
        });
        this.store.writeFile(cxapi.MANIFEST_FILE, JSON.stringify(manifest, undefined, 2));
        // write build manifest if we have build steps
        if (Object.keys(this.buildSteps).length > 0) {
            const buildManifest = {
                steps: this.buildSteps
            };
            this.store.writeFile(cxapi.BUILD_FILE, JSON.stringify(buildManifest, undefined, 2));
        }
        if (legacyManifest) {
            const legacy = Object.assign({}, manifest, { stacks: renderLegacyStacks(manifest, this.store) });
            // render the legacy manifest (cdk.out) which also contains a "stacks" attribute with all the rendered stacks.
            this.store.writeFile(cxapi.OUTFILE_NAME, JSON.stringify(legacy, undefined, 2));
        }
        this.store.lock();
        return manifest;
    }
}
exports.SynthesisSession = SynthesisSession;
/**
 * Can be used to prepare and emit synthesis artifacts into an output directory.
 */
class FileSystemStore {
    constructor(options) {
        this.locked = false;
        this.outdir = options.outdir;
        return;
    }
    writeFile(fileName, data) {
        this.canWrite(fileName);
        const p = this.pathForArtifact(fileName);
        fs.writeFileSync(p, data);
    }
    writeJson(fileName, json) {
        this.writeFile(fileName, JSON.stringify(json, undefined, 2));
    }
    readFile(fileName) {
        const p = this.pathForArtifact(fileName);
        if (!fs.existsSync(p)) {
            throw new Error(`File not found: ${p}`);
        }
        return fs.readFileSync(p);
    }
    readJson(fileName) {
        return JSON.parse(this.readFile(fileName).toString());
    }
    exists(name) {
        const p = this.pathForArtifact(name);
        return fs.existsSync(p);
    }
    mkdir(directoryName) {
        this.canWrite(directoryName);
        const p = this.pathForArtifact(directoryName);
        fs.mkdirSync(p);
        return p;
    }
    readdir(directoryName) {
        if (!this.exists(directoryName)) {
            throw new Error(`${directoryName} not found`);
        }
        const p = this.pathForArtifact(directoryName);
        return fs.readdirSync(p);
    }
    list() {
        return fs.readdirSync(this.outdir).sort();
    }
    lock() {
        this.locked = true;
    }
    pathForArtifact(id) {
        return path.join(this.outdir, id);
    }
    canWrite(artifactName) {
        if (this.exists(artifactName)) {
            throw new Error(`An artifact named ${artifactName} was already written to this session`);
        }
        if (this.locked) {
            throw new Error('Session has already been finalized');
        }
    }
}
exports.FileSystemStore = FileSystemStore;
class InMemoryStore {
    constructor() {
        this.files = {};
        this.dirs = {}; // value is path to a temporary directory
        this.locked = false;
    }
    writeFile(fileName, data) {
        this.canWrite(fileName);
        this.files[fileName] = data;
    }
    writeJson(fileName, json) {
        this.writeFile(fileName, JSON.stringify(json, undefined, 2));
    }
    readFile(fileName) {
        if (!(fileName in this.files)) {
            throw new Error(`${fileName} not found`);
        }
        return this.files[fileName];
    }
    readJson(fileName) {
        return JSON.parse(this.readFile(fileName).toString());
    }
    exists(name) {
        return name in this.files || name in this.dirs;
    }
    mkdir(directoryName) {
        this.canWrite(directoryName);
        const p = fs.mkdtempSync(path.join(os.tmpdir(), directoryName));
        this.dirs[directoryName] = p;
        return p;
    }
    readdir(directoryName) {
        if (!this.exists(directoryName)) {
            throw new Error(`${directoryName} not found`);
        }
        const p = this.dirs[directoryName];
        return fs.readdirSync(p);
    }
    list() {
        return [...Object.keys(this.files), ...Object.keys(this.dirs)].sort();
    }
    lock() {
        this.locked = true;
    }
    canWrite(artifactName) {
        if (this.exists(artifactName)) {
            throw new Error(`An artifact named ${artifactName} was already written to this session`);
        }
        if (this.locked) {
            throw new Error('Session has already been finalized');
        }
    }
}
exports.InMemoryStore = InMemoryStore;
function renderLegacyStacks(manifest, store) {
    // special case for backwards compat. build a list of stacks for the manifest
    const stacks = new Array();
    const artifacts = manifest.artifacts || {};
    for (const [id, artifact] of Object.entries(artifacts)) {
        if (artifact.type === cxapi.ArtifactType.AwsCloudFormationStack) {
            const templateFile = artifact.properties && artifact.properties.templateFile;
            if (!templateFile) {
                throw new Error(`Invalid cloudformation artifact. Missing "template" property`);
            }
            const template = store.readJson(templateFile);
            const match = cxapi.AWS_ENV_REGEX.exec(artifact.environment);
            if (!match) {
                throw new Error(`"environment" must match regex: ${cxapi.AWS_ENV_REGEX}`);
            }
            stacks.push(util_1.filterUndefined({
                name: id,
                environment: { name: artifact.environment.substr('aws://'.length), account: match[1], region: match[2] },
                template,
                metadata: artifact.metadata || {},
                autoDeploy: artifact.autoDeploy,
                dependsOn: artifact.dependencies && artifact.dependencies.length > 0 ? artifact.dependencies : undefined,
                missing: artifact.missing
            }));
        }
    }
    return stacks;
}
exports.renderLegacyStacks = renderLegacyStacks;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ludGhlc2lzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3ludGhlc2lzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUNBQTBDO0FBQzFDLHlCQUEwQjtBQUMxQix5QkFBMEI7QUFDMUIsNkJBQThCO0FBQzlCLDJDQUF5RDtBQUN6RCxpREFBMkQ7QUFDM0QsaUNBQXlDO0FBNkJ6QyxNQUFhLFdBQVc7SUFDZixVQUFVLENBQUMsSUFBZ0IsRUFBRSxVQUE0QixFQUFHO1FBQ2pFLE1BQU0sT0FBTyxHQUFHLElBQUksZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFOUMsdUVBQXVFO1FBRXZFLFVBQVU7UUFDVixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXhCLFdBQVc7UUFDWCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsY0FBYyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7UUFDdkYsSUFBSSxRQUFRLEVBQUU7WUFDWixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3hDLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQ3JCLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3ZGLE1BQU0sSUFBSSxLQUFLLENBQUMsbURBQW1ELFNBQVMsRUFBRSxDQUFDLENBQUM7YUFDakY7U0FDRjtRQUVELDRCQUE0QjtRQUM1QixLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDBCQUFjLENB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K0JDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGN4YXBpID0gcmVxdWlyZSgnQGF3cy1jZGsvY3gtYXBpJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgQ29uc3RydWN0T3JkZXIsIElDb25zdHJ1Y3QgfSBmcm9tICcuL2NvbnN0cnVjdCc7XG5pbXBvcnQgeyBjb2xsZWN0UnVudGltZUluZm9ybWF0aW9uIH0gZnJvbSAnLi9ydW50aW1lLWluZm8nO1xuaW1wb3J0IHsgZmlsdGVyVW5kZWZpbmVkIH0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IGludGVyZmFjZSBJU3ludGhlc2l6YWJsZSB7XG4gIHN5bnRoZXNpemUoc2Vzc2lvbjogSVN5bnRoZXNpc1Nlc3Npb24pOiB2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTeW50aGVzaXNTZXNzaW9uIHtcbiAgcmVhZG9ubHkgc3RvcmU6IElTZXNzaW9uU3RvcmU7XG4gIHJlYWRvbmx5IG1hbmlmZXN0OiBjeGFwaS5Bc3NlbWJseU1hbmlmZXN0O1xuICBhZGRBcnRpZmFjdChpZDogc3RyaW5nLCBkcm9wbGV0OiBjeGFwaS5BcnRpZmFjdCk6IHZvaWQ7XG4gIGFkZEJ1aWxkU3RlcChpZDogc3RyaW5nLCBzdGVwOiBjeGFwaS5CdWlsZFN0ZXApOiB2b2lkO1xuICB0cnlHZXRBcnRpZmFjdChpZDogc3RyaW5nKTogY3hhcGkuQXJ0aWZhY3QgfCB1bmRlZmluZWQ7XG4gIGdldEFydGlmYWN0KGlkOiBzdHJpbmcpOiBjeGFwaS5BcnRpZmFjdDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTeW50aGVzaXNPcHRpb25zIGV4dGVuZHMgTWFuaWZlc3RPcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBmaWxlIHN0b3JlIHVzZWQgZm9yIHRoaXMgc2Vzc2lvbi5cbiAgICogQGRlZmF1bHQgSW5NZW1vcnlTdG9yZVxuICAgKi9cbiAgcmVhZG9ubHkgc3RvcmU/OiBJU2Vzc2lvblN0b3JlO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHN5bnRoZXNpcyBzaG91bGQgc2tpcCB0aGUgdmFsaWRhdGlvbiBwaGFzZS5cbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IHNraXBWYWxpZGF0aW9uPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIFN5bnRoZXNpemVyIHtcbiAgcHVibGljIHN5bnRoZXNpemUocm9vdDogSUNvbnN0cnVjdCwgb3B0aW9uczogU3ludGhlc2lzT3B0aW9ucyA9IHsgfSk6IElTeW50aGVzaXNTZXNzaW9uIHtcbiAgICBjb25zdCBzZXNzaW9uID0gbmV3IFN5bnRoZXNpc1Nlc3Npb24ob3B0aW9ucyk7XG5cbiAgICAvLyB0aGUgdGhyZWUgaG9seSBwaGFzZXMgb2Ygc3ludGhlc2lzOiBwcmVwYXJlLCB2YWxpZGF0ZSBhbmQgc3ludGhlc2l6ZVxuXG4gICAgLy8gcHJlcGFyZVxuICAgIHJvb3Qubm9kZS5wcmVwYXJlVHJlZSgpO1xuXG4gICAgLy8gdmFsaWRhdGVcbiAgICBjb25zdCB2YWxpZGF0ZSA9IG9wdGlvbnMuc2tpcFZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhb3B0aW9ucy5za2lwVmFsaWRhdGlvbjtcbiAgICBpZiAodmFsaWRhdGUpIHtcbiAgICAgIGNvbnN0IGVycm9ycyA9IHJvb3Qubm9kZS52YWxpZGF0ZVRyZWUoKTtcbiAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBlcnJvckxpc3QgPSBlcnJvcnMubWFwKGUgPT4gYFske2Uuc291cmNlLm5vZGUucGF0aH1dICR7ZS5tZXNzYWdlfWApLmpvaW4oJ1xcbiAgJyk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsaWRhdGlvbiBmYWlsZWQgd2l0aCB0aGUgZm9sbG93aW5nIGVycm9yczpcXG4gICR7ZXJyb3JMaXN0fWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHN5bnRoZXNpemUgKGxlYXZlcyBmaXJzdClcbiAgICBmb3IgKGNvbnN0IGMgb2Ygcm9vdC5ub2RlLmZpbmRBbGwoQ29uc3RydWN0T3JkZXIuUG9zdE9yZGVyKSkge1xuICAgICAgaWYgKFN5bnRoZXNpc1Nlc3Npb24uaXNTeW50aGVzaXphYmxlKGMpKSB7XG4gICAgICAgIGMuc3ludGhlc2l6ZShzZXNzaW9uKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3cml0ZSBzZXNzaW9uIG1hbmlmZXN0IGFuZCBsb2NrIHN0b3JlXG4gICAgc2Vzc2lvbi5jbG9zZShvcHRpb25zKTtcblxuICAgIHJldHVybiBzZXNzaW9uO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBTeW50aGVzaXNTZXNzaW9uIGltcGxlbWVudHMgSVN5bnRoZXNpc1Nlc3Npb24ge1xuICAvKipcbiAgICogQHJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpbXBsZW1lbnRzIGBJU3ludGhlc2l6YWJsZWAuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGlzU3ludGhlc2l6YWJsZShvYmo6IGFueSk6IG9iaiBpcyBJU3ludGhlc2l6YWJsZSB7XG4gICAgcmV0dXJuICdzeW50aGVzaXplJyBpbiBvYmo7XG4gIH1cblxuICBwdWJsaWMgcmVhZG9ubHkgc3RvcmU6IElTZXNzaW9uU3RvcmU7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBhcnRpZmFjdHM6IHsgW2lkOiBzdHJpbmddOiBjeGFwaS5BcnRpZmFjdCB9ID0geyB9O1xuICBwcml2YXRlIHJlYWRvbmx5IGJ1aWxkU3RlcHM6IHsgW2lkOiBzdHJpbmddOiBjeGFwaS5CdWlsZFN0ZXAgfSA9IHsgfTtcbiAgcHJpdmF0ZSBfbWFuaWZlc3Q/OiBjeGFwaS5Bc3NlbWJseU1hbmlmZXN0O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFN5bnRoZXNpc09wdGlvbnMpIHtcbiAgICB0aGlzLnN0b3JlID0gb3B0aW9ucy5zdG9yZSB8fCBuZXcgSW5NZW1vcnlTdG9yZSgpO1xuICB9XG5cbiAgcHVibGljIGdldCBtYW5pZmVzdCgpIHtcbiAgICBpZiAoIXRoaXMuX21hbmlmZXN0KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCByZWFkIGFzc2VtYmx5IG1hbmlmZXN0IGJlZm9yZSB0aGUgc2Vzc2lvbiBoYXMgYmVlbiBmaW5hbGl6ZWRgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fbWFuaWZlc3Q7XG4gIH1cblxuICBwdWJsaWMgYWRkQXJ0aWZhY3QoaWQ6IHN0cmluZywgYXJ0aWZhY3Q6IGN4YXBpLkFydGlmYWN0KTogdm9pZCB7XG4gICAgY3hhcGkudmFsaWRhdGVBcnRpZmFjdChhcnRpZmFjdCk7XG4gICAgdGhpcy5hcnRpZmFjdHNbaWRdID0gZmlsdGVyVW5kZWZpbmVkKGFydGlmYWN0KTtcbiAgfVxuXG4gIHB1YmxpYyB0cnlHZXRBcnRpZmFjdChpZDogc3RyaW5nKTogY3hhcGkuQXJ0aWZhY3QgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmFydGlmYWN0c1tpZF07XG4gIH1cblxuICBwdWJsaWMgZ2V0QXJ0aWZhY3QoaWQ6IHN0cmluZyk6IGN4YXBpLkFydGlmYWN0IHtcbiAgICBjb25zdCBhcnRpZmFjdCA9IHRoaXMudHJ5R2V0QXJ0aWZhY3QoaWQpO1xuICAgIGlmICghYXJ0aWZhY3QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGZpbmQgYXJ0aWZhY3QgJHtpZH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGFydGlmYWN0O1xuICB9XG5cbiAgcHVibGljIGFkZEJ1aWxkU3RlcChpZDogc3RyaW5nLCBzdGVwOiBjeGFwaS5CdWlsZFN0ZXApIHtcbiAgICBpZiAoaWQgaW4gdGhpcy5idWlsZFN0ZXBzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEJ1aWxkIHN0ZXAgJHtpZH0gYWxyZWFkeSBleGlzdHNgKTtcbiAgICB9XG4gICAgdGhpcy5idWlsZFN0ZXBzW2lkXSA9IGZpbHRlclVuZGVmaW5lZChzdGVwKTtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZShvcHRpb25zOiBNYW5pZmVzdE9wdGlvbnMgPSB7IH0pOiBjeGFwaS5Bc3NlbWJseU1hbmlmZXN0IHtcbiAgICBjb25zdCBsZWdhY3lNYW5pZmVzdCA9IG9wdGlvbnMubGVnYWN5TWFuaWZlc3QgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubGVnYWN5TWFuaWZlc3QgOiBmYWxzZTtcbiAgICBjb25zdCBydW50aW1lSW5mbyA9IG9wdGlvbnMucnVudGltZUluZm9ybWF0aW9uICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnJ1bnRpbWVJbmZvcm1hdGlvbiA6IHRydWU7XG5cbiAgICBjb25zdCBtYW5pZmVzdDogY3hhcGkuQXNzZW1ibHlNYW5pZmVzdCA9IHRoaXMuX21hbmlmZXN0ID0gZmlsdGVyVW5kZWZpbmVkKHtcbiAgICAgIHZlcnNpb246IGN4YXBpLlBST1RPX1JFU1BPTlNFX1ZFUlNJT04sXG4gICAgICBhcnRpZmFjdHM6IHRoaXMuYXJ0aWZhY3RzLFxuICAgICAgcnVudGltZTogcnVudGltZUluZm8gPyBjb2xsZWN0UnVudGltZUluZm9ybWF0aW9uKCkgOiB1bmRlZmluZWRcbiAgICB9KTtcblxuICAgIHRoaXMuc3RvcmUud3JpdGVGaWxlKGN4YXBpLk1BTklGRVNUX0ZJTEUsIEpTT04uc3RyaW5naWZ5KG1hbmlmZXN0LCB1bmRlZmluZWQsIDIpKTtcblxuICAgIC8vIHdyaXRlIGJ1aWxkIG1hbmlmZXN0IGlmIHdlIGhhdmUgYnVpbGQgc3RlcHNcbiAgICBpZiAoT2JqZWN0LmtleXModGhpcy5idWlsZFN0ZXBzKS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBidWlsZE1hbmlmZXN0OiBjeGFwaS5CdWlsZE1hbmlmZXN0ID0ge1xuICAgICAgICBzdGVwczogdGhpcy5idWlsZFN0ZXBzXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnN0b3JlLndyaXRlRmlsZShjeGFwaS5CVUlMRF9GSUxFLCBKU09OLnN0cmluZ2lmeShidWlsZE1hbmlmZXN0LCB1bmRlZmluZWQsIDIpKTtcbiAgICB9XG5cbiAgICBpZiAobGVnYWN5TWFuaWZlc3QpIHtcbiAgICAgIGNvbnN0IGxlZ2FjeTogY3hhcGkuU3ludGhlc2l6ZVJlc3BvbnNlID0ge1xuICAgICAgICAuLi5tYW5pZmVzdCxcbiAgICAgICAgc3RhY2tzOiByZW5kZXJMZWdhY3lTdGFja3MobWFuaWZlc3QsIHRoaXMuc3RvcmUpXG4gICAgICB9O1xuXG4gICAgICAvLyByZW5kZXIgdGhlIGxlZ2FjeSBtYW5pZmVzdCAoY2RrLm91dCkgd2hpY2ggYWxzbyBjb250YWlucyBhIFwic3RhY2tzXCIgYXR0cmlidXRlIHdpdGggYWxsIHRoZSByZW5kZXJlZCBzdGFja3MuXG4gICAgICB0aGlzLnN0b3JlLndyaXRlRmlsZShjeGFwaS5PVVRGSUxFX05BTUUsIEpTT04uc3RyaW5naWZ5KGxlZ2FjeSwgdW5kZWZpbmVkLCAyKSk7XG4gICAgfVxuXG4gICAgdGhpcy5zdG9yZS5sb2NrKCk7XG5cbiAgICByZXR1cm4gbWFuaWZlc3Q7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBNYW5pZmVzdE9wdGlvbnMge1xuICAvKipcbiAgICogRW1pdCB0aGUgbGVnYWN5IG1hbmlmZXN0IChgY2RrLm91dGApIHdoZW4gdGhlIHNlc3Npb24gaXMgY2xvc2VkIChhbG9uZ3NpZGUgYG1hbmlmZXN0Lmpzb25gKS5cbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IGxlZ2FjeU1hbmlmZXN0PzogYm9vbGVhbjtcblxuICAvKipcbiAgICogSW5jbHVkZSBydW50aW1lIGluZm9ybWF0aW9uIChtb2R1bGUgdmVyc2lvbnMpIGluIG1hbmlmZXN0LlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSBydW50aW1lSW5mb3JtYXRpb24/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTZXNzaW9uU3RvcmUge1xuICAvKipcbiAgICogQ3JlYXRlcyBhIGRpcmVjdG9yeSBhbmQgcmV0dXJucyBpdCdzIGZ1bGwgcGF0aC5cbiAgICogQHBhcmFtIGRpcmVjdG9yeU5hbWUgVGhlIG5hbWUgb2YgdGhlIGRpcmVjdG9yeSB0byBjcmVhdGUuXG4gICAqIEB0aHJvd3MgaWYgYSBkaXJlY3RvcnkgYnkgdGhhdCBuYW1lIGFscmVhZHkgZXhpc3RzIGluIHRoZSBzZXNzaW9uIG9yIGlmIHRoZSBzZXNzaW9uIGhhcyBhbHJlYWR5IGJlZW4gZmluYWxpemVkLlxuICAgKi9cbiAgbWtkaXIoZGlyZWN0b3J5TmFtZTogc3RyaW5nKTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBsaXN0IG9mIGZpbGVzIGluIGEgZGlyZWN0b3J5LlxuICAgKiBAcGFyYW0gZGlyZWN0b3J5TmFtZSBUaGUgbmFtZSBvZiB0aGUgYXJ0aWZhY3RcbiAgICogQHRocm93cyBpZiB0aGVyZSBpcyBubyBkaXJlY3RvcnkgYXJ0aWZhY3QgdW5kZXIgdGhpcyBuYW1lXG4gICAqL1xuICByZWFkZGlyKGRpcmVjdG9yeU5hbWU6IHN0cmluZyk6IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBXcml0ZXMgYSBmaWxlIGludG8gdGhlIHN0b3JlLlxuICAgKiBAcGFyYW0gYXJ0aWZhY3ROYW1lIFRoZSBuYW1lIG9mIHRoZSBmaWxlLlxuICAgKiBAcGFyYW0gZGF0YSBUaGUgY29udGVudHMgb2YgdGhlIGZpbGUuXG4gICAqL1xuICB3cml0ZUZpbGUoYXJ0aWZhY3ROYW1lOiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIFdyaXRlcyBhIGZvcm1hdHRlZCBKU09OIG91dHB1dCBmaWxlIHRvIHRoZSBzdG9yZVxuICAgKiBAcGFyYW0gYXJ0aWZhY3ROYW1lIHRoZSBuYW1lIG9mIHRoZSBhcnRpZmFjdFxuICAgKiBAcGFyYW0ganNvbiB0aGUgSlNPTiBvYmplY3RcbiAgICovXG4gIHdyaXRlSnNvbihhcnRpZmFjdE5hbWU6IHN0cmluZywganNvbjogYW55KTogdm9pZDtcblxuICAvKipcbiAgICogUmVhZHMgYSBmaWxlIGZyb20gdGhlIHN0b3JlLlxuICAgKiBAcGFyYW0gZmlsZU5hbWUgVGhlIG5hbWUgb2YgdGhlIGZpbGUuXG4gICAqIEB0aHJvd3MgaWYgdGhlIGZpbGUgaXMgbm90IGZvdW5kXG4gICAqL1xuICByZWFkRmlsZShmaWxlTmFtZTogc3RyaW5nKTogYW55O1xuXG4gIC8qKlxuICAgKiBSZWFkcyBhIEpTT04gb2JqZWN0IGZyb20gdGhlIHN0b3JlLlxuICAgKi9cbiAgcmVhZEpzb24oZmlsZU5hbWU6IHN0cmluZyk6IGFueTtcblxuICAvKipcbiAgICogQHJldHVybnMgdHJ1ZSBpZiB0aGUgZmlsZSBgZmlsZU5hbWVgIGV4aXN0cyBpbiB0aGUgc3RvcmUuXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBmaWxlIG9yIGRpcmVjdG9yeSB0byBsb29rIHVwLlxuICAgKi9cbiAgZXhpc3RzKG5hbWU6IHN0cmluZyk6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIExpc3QgYWxsIHRvcC1sZXZlbCBmaWxlcyB0aGF0IHdlcmUgZW1pdHRlZCB0byB0aGUgc3RvcmUuXG4gICAqL1xuICBsaXN0KCk6IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBEbyBub3QgYWxsb3cgZnVydGhlciB3cml0ZXMgaW50byB0aGUgc3RvcmUuXG4gICAqL1xuICBsb2NrKCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZVN5c3RlbVN0b3JlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgb3V0cHV0IGRpcmVjdG9yeSBmb3Igc3ludGhlc2lzIGFydGlmYWN0c1xuICAgKi9cbiAgcmVhZG9ubHkgb3V0ZGlyOiBzdHJpbmc7XG59XG5cbi8qKlxuICogQ2FuIGJlIHVzZWQgdG8gcHJlcGFyZSBhbmQgZW1pdCBzeW50aGVzaXMgYXJ0aWZhY3RzIGludG8gYW4gb3V0cHV0IGRpcmVjdG9yeS5cbiAqL1xuZXhwb3J0IGNsYXNzIEZpbGVTeXN0ZW1TdG9yZSBpbXBsZW1lbnRzIElTZXNzaW9uU3RvcmUge1xuICBwcml2YXRlIHJlYWRvbmx5IG91dGRpcjogc3RyaW5nO1xuICBwcml2YXRlIGxvY2tlZCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IEZpbGVTeXN0ZW1TdG9yZU9wdGlvbnMpIHtcbiAgICB0aGlzLm91dGRpciA9IG9wdGlvbnMub3V0ZGlyO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZUZpbGUoZmlsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KSB7XG4gICAgdGhpcy5jYW5Xcml0ZShmaWxlTmFtZSk7XG5cbiAgICBjb25zdCBwID0gdGhpcy5wYXRoRm9yQXJ0aWZhY3QoZmlsZU5hbWUpO1xuICAgIGZzLndyaXRlRmlsZVN5bmMocCwgZGF0YSk7XG4gIH1cblxuICBwdWJsaWMgd3JpdGVKc29uKGZpbGVOYW1lOiBzdHJpbmcsIGpzb246IGFueSkge1xuICAgIHRoaXMud3JpdGVGaWxlKGZpbGVOYW1lLCBKU09OLnN0cmluZ2lmeShqc29uLCB1bmRlZmluZWQsIDIpKTtcbiAgfVxuXG4gIHB1YmxpYyByZWFkRmlsZShmaWxlTmFtZTogc3RyaW5nKTogYW55IHtcbiAgICBjb25zdCBwID0gdGhpcy5wYXRoRm9yQXJ0aWZhY3QoZmlsZU5hbWUpO1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhwKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIG5vdCBmb3VuZDogJHtwfWApO1xuICAgIH1cblxuICAgIHJldHVybiBmcy5yZWFkRmlsZVN5bmMocCk7XG4gIH1cblxuICBwdWJsaWMgcmVhZEpzb24oZmlsZU5hbWU6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UodGhpcy5yZWFkRmlsZShmaWxlTmFtZSkudG9TdHJpbmcoKSk7XG4gIH1cblxuICBwdWJsaWMgZXhpc3RzKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHAgPSB0aGlzLnBhdGhGb3JBcnRpZmFjdChuYW1lKTtcbiAgICByZXR1cm4gZnMuZXhpc3RzU3luYyhwKTtcbiAgfVxuXG4gIHB1YmxpYyBta2RpcihkaXJlY3RvcnlOYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHRoaXMuY2FuV3JpdGUoZGlyZWN0b3J5TmFtZSk7XG4gICAgY29uc3QgcCA9IHRoaXMucGF0aEZvckFydGlmYWN0KGRpcmVjdG9yeU5hbWUpO1xuICAgIGZzLm1rZGlyU3luYyhwKTtcbiAgICByZXR1cm4gcDtcbiAgfVxuXG4gIHB1YmxpYyByZWFkZGlyKGRpcmVjdG9yeU5hbWU6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICBpZiAoIXRoaXMuZXhpc3RzKGRpcmVjdG9yeU5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZGlyZWN0b3J5TmFtZX0gbm90IGZvdW5kYCk7XG4gICAgfVxuXG4gICAgY29uc3QgcCA9IHRoaXMucGF0aEZvckFydGlmYWN0KGRpcmVjdG9yeU5hbWUpO1xuICAgIHJldHVybiBmcy5yZWFkZGlyU3luYyhwKTtcbiAgfVxuXG4gIHB1YmxpYyBsaXN0KCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gZnMucmVhZGRpclN5bmModGhpcy5vdXRkaXIpLnNvcnQoKTtcbiAgfVxuXG4gIHB1YmxpYyBsb2NrKCkge1xuICAgIHRoaXMubG9ja2VkID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgcGF0aEZvckFydGlmYWN0KGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMub3V0ZGlyLCBpZCk7XG4gIH1cblxuICBwcml2YXRlIGNhbldyaXRlKGFydGlmYWN0TmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuZXhpc3RzKGFydGlmYWN0TmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQW4gYXJ0aWZhY3QgbmFtZWQgJHthcnRpZmFjdE5hbWV9IHdhcyBhbHJlYWR5IHdyaXR0ZW4gdG8gdGhpcyBzZXNzaW9uYCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmxvY2tlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTZXNzaW9uIGhhcyBhbHJlYWR5IGJlZW4gZmluYWxpemVkJyk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBJbk1lbW9yeVN0b3JlIGltcGxlbWVudHMgSVNlc3Npb25TdG9yZSB7XG4gIHByaXZhdGUgZmlsZXM6IHsgW2ZpbGVOYW1lOiBzdHJpbmddOiBhbnkgfSA9IHsgfTtcbiAgcHJpdmF0ZSBkaXJzOiB7IFtkaXJOYW1lOiBzdHJpbmddOiBzdHJpbmcgfSA9IHsgfTsgLy8gdmFsdWUgaXMgcGF0aCB0byBhIHRlbXBvcmFyeSBkaXJlY3RvcnlcblxuICBwcml2YXRlIGxvY2tlZCA9IGZhbHNlO1xuXG4gIHB1YmxpYyB3cml0ZUZpbGUoZmlsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5jYW5Xcml0ZShmaWxlTmFtZSk7XG4gICAgdGhpcy5maWxlc1tmaWxlTmFtZV0gPSBkYXRhO1xuICB9XG5cbiAgcHVibGljIHdyaXRlSnNvbihmaWxlTmFtZTogc3RyaW5nLCBqc29uOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLndyaXRlRmlsZShmaWxlTmFtZSwgSlNPTi5zdHJpbmdpZnkoanNvbiwgdW5kZWZpbmVkLCAyKSk7XG4gIH1cblxuICBwdWJsaWMgcmVhZEZpbGUoZmlsZU5hbWU6IHN0cmluZykge1xuICAgIGlmICghKGZpbGVOYW1lIGluIHRoaXMuZmlsZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZmlsZU5hbWV9IG5vdCBmb3VuZGApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5maWxlc1tmaWxlTmFtZV07XG4gIH1cblxuICBwdWJsaWMgcmVhZEpzb24oZmlsZU5hbWU6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UodGhpcy5yZWFkRmlsZShmaWxlTmFtZSkudG9TdHJpbmcoKSk7XG4gIH1cblxuICBwdWJsaWMgZXhpc3RzKG5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiBuYW1lIGluIHRoaXMuZmlsZXMgfHwgbmFtZSBpbiB0aGlzLmRpcnM7XG4gIH1cblxuICBwdWJsaWMgbWtkaXIoZGlyZWN0b3J5TmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICB0aGlzLmNhbldyaXRlKGRpcmVjdG9yeU5hbWUpO1xuXG4gICAgY29uc3QgcCA9IGZzLm1rZHRlbXBTeW5jKHBhdGguam9pbihvcy50bXBkaXIoKSwgZGlyZWN0b3J5TmFtZSkpO1xuICAgIHRoaXMuZGlyc1tkaXJlY3RvcnlOYW1lXSA9IHA7XG4gICAgcmV0dXJuIHA7XG4gIH1cblxuICBwdWJsaWMgcmVhZGRpcihkaXJlY3RvcnlOYW1lOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgaWYgKCF0aGlzLmV4aXN0cyhkaXJlY3RvcnlOYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2RpcmVjdG9yeU5hbWV9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGNvbnN0IHAgPSB0aGlzLmRpcnNbZGlyZWN0b3J5TmFtZV07XG4gICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKHApO1xuICB9XG5cbiAgcHVibGljIGxpc3QoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiBbIC4uLk9iamVjdC5rZXlzKHRoaXMuZmlsZXMpLCAuLi5PYmplY3Qua2V5cyh0aGlzLmRpcnMpIF0uc29ydCgpO1xuICB9XG5cbiAgcHVibGljIGxvY2soKSB7XG4gICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5Xcml0ZShhcnRpZmFjdE5hbWU6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmV4aXN0cyhhcnRpZmFjdE5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEFuIGFydGlmYWN0IG5hbWVkICR7YXJ0aWZhY3ROYW1lfSB3YXMgYWxyZWFkeSB3cml0dGVuIHRvIHRoaXMgc2Vzc2lvbmApO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2NrZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignU2Vzc2lvbiBoYXMgYWxyZWFkeSBiZWVuIGZpbmFsaXplZCcpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyTGVnYWN5U3RhY2tzKG1hbmlmZXN0OiBjeGFwaS5Bc3NlbWJseU1hbmlmZXN0LCBzdG9yZTogSVNlc3Npb25TdG9yZSkge1xuICAvLyBzcGVjaWFsIGNhc2UgZm9yIGJhY2t3YXJkcyBjb21wYXQuIGJ1aWxkIGEgbGlzdCBvZiBzdGFja3MgZm9yIHRoZSBtYW5pZmVzdFxuICBjb25zdCBzdGFja3MgPSBuZXcgQXJyYXk8Y3hhcGkuU3ludGhlc2l6ZWRTdGFjaz4oKTtcbiAgY29uc3QgYXJ0aWZhY3RzID0gbWFuaWZlc3QuYXJ0aWZhY3RzIHx8IHsgfTtcblxuICBmb3IgKGNvbnN0IFsgaWQsIGFydGlmYWN0IF0gb2YgT2JqZWN0LmVudHJpZXMoYXJ0aWZhY3RzKSkge1xuICAgIGlmIChhcnRpZmFjdC50eXBlID09PSBjeGFwaS5BcnRpZmFjdFR5cGUuQXdzQ2xvdWRGb3JtYXRpb25TdGFjaykge1xuICAgICAgY29uc3QgdGVtcGxhdGVGaWxlID0gYXJ0aWZhY3QucHJvcGVydGllcyAmJiBhcnRpZmFjdC5wcm9wZXJ0aWVzLnRlbXBsYXRlRmlsZTtcbiAgICAgIGlmICghdGVtcGxhdGVGaWxlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBjbG91ZGZvcm1hdGlvbiBhcnRpZmFjdC4gTWlzc2luZyBcInRlbXBsYXRlXCIgcHJvcGVydHlgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gc3RvcmUucmVhZEpzb24odGVtcGxhdGVGaWxlKTtcblxuICAgICAgY29uc3QgbWF0Y2ggPSBjeGFwaS5BV1NfRU5WX1JFR0VYLmV4ZWMoYXJ0aWZhY3QuZW52aXJvbm1lbnQpO1xuICAgICAgaWYgKCFtYXRjaCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFwiZW52aXJvbm1lbnRcIiBtdXN0IG1hdGNoIHJlZ2V4OiAke2N4YXBpLkFXU19FTlZfUkVHRVh9YCk7XG4gICAgICB9XG5cbiAgICAgIHN0YWNrcy5wdXNoKGZpbHRlclVuZGVmaW5lZCh7XG4gICAgICAgIG5hbWU6IGlkLFxuICAgICAgICBlbnZpcm9ubWVudDogeyBuYW1lOiBhcnRpZmFjdC5lbnZpcm9ubWVudC5zdWJzdHIoJ2F3czovLycubGVuZ3RoKSwgYWNjb3VudDogbWF0Y2hbMV0sIHJlZ2lvbjogbWF0Y2hbMl0gfSxcbiAgICAgICAgdGVtcGxhdGUsXG4gICAgICAgIG1ldGFkYXRhOiBhcnRpZmFjdC5tZXRhZGF0YSB8fCB7fSxcbiAgICAgICAgYXV0b0RlcGxveTogYXJ0aWZhY3QuYXV0b0RlcGxveSxcbiAgICAgICAgZGVwZW5kc09uOiBhcnRpZmFjdC5kZXBlbmRlbmNpZXMgJiYgYXJ0aWZhY3QuZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDAgPyBhcnRpZmFjdC5kZXBlbmRlbmNpZXMgOiB1bmRlZmluZWQsXG4gICAgICAgIG1pc3Npbmc6IGFydGlmYWN0Lm1pc3NpbmdcbiAgICAgIH0pKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gc3RhY2tzO1xufVxuIl19